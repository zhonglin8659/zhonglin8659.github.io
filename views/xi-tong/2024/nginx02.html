<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx进阶 | SugarysBlog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://sugarys.oss-cn-beijing.aliyuncs.com/staticresources/favicon.ico">
    <meta name="description" content="兜里有糖">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.54ce2a26.css" as="style"><link rel="preload" href="/assets/js/app.04483c44.js" as="script"><link rel="preload" href="/assets/js/3.46854e42.js" as="script"><link rel="preload" href="/assets/js/1.32674175.js" as="script"><link rel="preload" href="/assets/js/34.0f5f0754.js" as="script"><link rel="preload" href="/assets/js/9.601bab32.js" as="script"><link rel="prefetch" href="/assets/js/10.b75e4695.js"><link rel="prefetch" href="/assets/js/11.bfab7f66.js"><link rel="prefetch" href="/assets/js/12.cf7bacd5.js"><link rel="prefetch" href="/assets/js/13.625c70b0.js"><link rel="prefetch" href="/assets/js/14.d3714737.js"><link rel="prefetch" href="/assets/js/15.0a19d2b9.js"><link rel="prefetch" href="/assets/js/16.eea56816.js"><link rel="prefetch" href="/assets/js/17.ef7a5349.js"><link rel="prefetch" href="/assets/js/18.c91d9fb8.js"><link rel="prefetch" href="/assets/js/19.37d129a8.js"><link rel="prefetch" href="/assets/js/20.b4f31562.js"><link rel="prefetch" href="/assets/js/21.60d71c60.js"><link rel="prefetch" href="/assets/js/22.2e0529e7.js"><link rel="prefetch" href="/assets/js/23.12ee2461.js"><link rel="prefetch" href="/assets/js/24.000fb0a0.js"><link rel="prefetch" href="/assets/js/25.8a7b8f78.js"><link rel="prefetch" href="/assets/js/26.7780e88d.js"><link rel="prefetch" href="/assets/js/27.d79a92f4.js"><link rel="prefetch" href="/assets/js/28.1754e930.js"><link rel="prefetch" href="/assets/js/29.be3120c2.js"><link rel="prefetch" href="/assets/js/30.9d80882d.js"><link rel="prefetch" href="/assets/js/31.c81edbdc.js"><link rel="prefetch" href="/assets/js/32.c6eca221.js"><link rel="prefetch" href="/assets/js/33.6058f83c.js"><link rel="prefetch" href="/assets/js/35.d05949b3.js"><link rel="prefetch" href="/assets/js/36.0051583d.js"><link rel="prefetch" href="/assets/js/37.43d51e78.js"><link rel="prefetch" href="/assets/js/38.44d09205.js"><link rel="prefetch" href="/assets/js/39.08bb2b26.js"><link rel="prefetch" href="/assets/js/4.549b3535.js"><link rel="prefetch" href="/assets/js/40.22399a20.js"><link rel="prefetch" href="/assets/js/41.662330f3.js"><link rel="prefetch" href="/assets/js/42.c31a6a56.js"><link rel="prefetch" href="/assets/js/43.b42d7a00.js"><link rel="prefetch" href="/assets/js/44.d57a33b4.js"><link rel="prefetch" href="/assets/js/45.efa0cdf2.js"><link rel="prefetch" href="/assets/js/46.6c811c53.js"><link rel="prefetch" href="/assets/js/47.08316a1f.js"><link rel="prefetch" href="/assets/js/48.3cd5f46b.js"><link rel="prefetch" href="/assets/js/49.3bba761f.js"><link rel="prefetch" href="/assets/js/5.dff40954.js"><link rel="prefetch" href="/assets/js/50.3cecfe5c.js"><link rel="prefetch" href="/assets/js/51.f23b9faa.js"><link rel="prefetch" href="/assets/js/52.9104478d.js"><link rel="prefetch" href="/assets/js/53.9ee2816f.js"><link rel="prefetch" href="/assets/js/6.2da1c4b4.js"><link rel="prefetch" href="/assets/js/7.0d026352.js"><link rel="prefetch" href="/assets/js/8.b073709a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.54ce2a26.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-130b300a><div data-v-130b300a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-130b300a data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>SugarysBlog</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>兜里有糖</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>兜里有糖</span>
            
          <span data-v-25ba6db2>2021 - </span>
          2025
        </a></span></div></div> <div class="hide" data-v-130b300a><header class="navbar" data-v-130b300a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/staticresources/logo.png" alt="SugarysBlog" class="logo"> <span class="site-name">SugarysBlog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/笔记/" class="nav-link"><i class="undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/运维/" class="nav-link"><i class="undefined"></i>
  运维
</a></li><li class="dropdown-item"><!----> <a href="/categories/网络/" class="nav-link"><i class="undefined"></i>
  网络
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/note/" class="nav-link"><i class="iconfont reco-document"></i>
  笔记
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-130b300a></div> <aside class="sidebar" data-v-130b300a><div class="personal-info-wrapper" data-v-39576ba9 data-v-130b300a><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/staticresources/author.jpg" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    兜里有糖
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>39</h3> <h6 data-v-39576ba9>文章</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>11</h3> <h6 data-v-39576ba9>标签</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/笔记/" class="nav-link"><i class="undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/运维/" class="nav-link"><i class="undefined"></i>
  运维
</a></li><li class="dropdown-item"><!----> <a href="/categories/网络/" class="nav-link"><i class="undefined"></i>
  网络
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/note/" class="nav-link"><i class="iconfont reco-document"></i>
  笔记
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Nginx进阶</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>兜里有糖</span>
            
          <span data-v-25ba6db2>2021 - </span>
          2025
        </a></span></div></div> <div data-v-130b300a><main class="page"><section><div class="page-title"><h1 class="title">Nginx进阶</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>兜里有糖</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>2024/7/24</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>集群</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="nginx进阶"><a href="#nginx进阶" class="header-anchor">#</a> Nginx进阶</h2> <h2 id="nginx服务器基础配置实例"><a href="#nginx服务器基础配置实例" class="header-anchor">#</a> Nginx服务器基础配置实例</h2> <p>前面我们已经对Nginx服务器默认配置文件的结构和涉及的基本指令做了详细的阐述。通过这些指令的合理配置，我们就可以让一台Nginx服务器正常工作，并且提供基本的web服务器功能。</p> <p>接下来我们将通过一个比较完整和最简单的基础配置实例，来巩固下前面所学习的指令及其配置。</p> <p>需求如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>（1）有如下访问：
	http://192.168.200.133:8081/server1/location1
		访问的是：index_sr1_location1.html
	http://192.168.200.133:8081/server1/location2
		访问的是：index_sr1_location2.html
	http://192.168.200.133:8082/server2/location1
		访问的是：index_sr2_location1.html
	http://192.168.200.133:8082/server2/location2
		访问的是：index_sr2_location2.html
（2）如果访问的资源不存在，
	返回自定义的404页面
（3）将/server1和/server2的配置使用不同的配置文件分割
	将文件放到/home/www/conf.d目录下，然后使用include进行合并
（4）为/server1和/server2各自创建一个访问日志文件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>准备相关文件，目录如下：</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587129309340.png" alt="1587129309340"></p> <p>配置的内容如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
##全局块 begin##
#配置允许运行Nginx工作进程的用户和用户组
user www;
#配置运行Nginx进程生成的worker进程数
worker_processes 2;
#配置Nginx服务器运行对错误日志存放的路径
error_log logs/error.log;
#配置Nginx服务器允许时记录Nginx的master进程的PID文件路径和名称
pid logs/nginx.pid;
#配置Nginx服务是否以守护进程方法启动
#daemon on;
##全局块 end##

##events块 begin##
events{
	#设置Nginx网络连接序列化
	accept_mutex on;
	#设置Nginx的worker进程是否可以同时接收多个请求
	multi_accept on;
	#设置Nginx的worker进程最大的连接数
	worker_connections 1024;
	#设置Nginx使用的事件驱动模型
	use epoll;
}
##events块 end##
##http块 start##
http{
	#定义MIME-Type
	include mime.types;
	default_type application/octet-stream;
	#配置允许使用sendfile方式运输
	sendfile on;
	#配置连接超时时间
	keepalive_timeout 65;
	#配置请求处理日志格式
	log_format server1 '===&gt;server1 access log';
	log_format server2 '===&gt;server2 access log';
	##server块 开始##
	include /home/www/conf.d/*.conf;
	##server块 结束##
}
##http块 end##
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>server1.conf</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
		#配置监听端口和主机名称
		listen 8081;
		server_name localhost;
		#配置请求处理日志存放路径
		access_log /home/www/myweb/server1/logs/access.log server1;
		#配置错误页面
		error_page 404 /404.html;
		#配置处理/server1/location1请求的location
		location /server1/location1{
			root /home/www/myweb;
			index index_sr1_location1.html;
		}
		#配置处理/server1/location2请求的location
		location /server1/location2{
			root /home/www/myweb;
			index index_sr1_location2.html;
		}
		#配置错误页面转向
		location = /404.html {
			root /home/www/myweb;
			index 404.html;
		}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>server2.conf</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
		#配置监听端口和主机名称
		listen 8082;
		server_name localhost;
		#配置请求处理日志存放路径
		access_log /home/www/myweb/server2/logs/access.log server2;
		#配置错误页面,对404.html做了定向配置
		error_page 404 /404.html;
		#配置处理/server1/location1请求的location
		location /server2/location1{
			root /home/www/myweb;
			index index_sr2_location1.html;
		}
		#配置处理/server2/location2请求的location
		location /server2/location2{
			root /home/www/myweb;
			index index_sr2_location2.html;
		}
		#配置错误页面转向
		location = /404.html {
			root /home/www/myweb;
			index 404.html;
		}
	}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>访问测试：</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587129766585.png" alt="1587129766585"></p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587129777898.png" alt="1587129777898"></p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587290246228.png" alt="1587290246228"></p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587129805309.png" alt="1587129805309"></p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587129817226.png" alt="1587129817226"></p> <h2 id="nginx服务操作的问题"><a href="#nginx服务操作的问题" class="header-anchor">#</a> Nginx服务操作的问题</h2> <p>经过前面的操作，我们会发现，如果想要启动、关闭或重新加载nginx配置文件，都需要先进入到nginx的安装目录的sbin目录，然后使用nginx的二级制可执行文件来操作，相对来说操作比较繁琐，这块该如何优化？另外如果我们想把Nginx设置成随着服务器启动就自动完成启动操作，又该如何来实现?这就需要用到接下来我们要讲解的两个知识点：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Nginx配置成系统服务
Nginx命令配置到系统环境
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="nginx配置成系统服务"><a href="#nginx配置成系统服务" class="header-anchor">#</a> Nginx配置成系统服务</h2> <p>把Nginx应用服务设置成为系统服务，方便对Nginx服务的启动和停止等相关操作，具体实现步骤:</p> <p>(1) 在<code>/usr/lib/systemd/system</code>目录下添加nginx.service,内容如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /usr/lib/systemd/system/nginx.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>[Unit]
Description=nginx web service
Documentation=http://nginx.org/en/docs/
After=network.target

[Service]
Type=forking
PIDFile=/usr/local/nginx/logs/nginx.pid
ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf
ExecStart=/usr/local/nginx/sbin/nginx
ExecReload=/usr/local/nginx/sbin/nginx -s reload
ExecStop=/usr/local/nginx/sbin/nginx -s stop
PrivateTmp=true

[Install]
WantedBy=default.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>(2)添加完成后如果权限有问题需要进行权限设置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>chmod 755 /usr/lib/systemd/system/nginx.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>(3)使用系统命令来操作Nginx服务</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>启动: systemctl start nginx
停止: systemctl stop nginx
重启: systemctl restart nginx
重新加载配置文件: systemctl reload nginx
查看nginx状态: systemctl status nginx
开机启动: systemctl enable nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="nginx命令配置到系统环境"><a href="#nginx命令配置到系统环境" class="header-anchor">#</a> Nginx命令配置到系统环境</h2> <p>前面我们介绍过Nginx安装目录下的二级制可执行文件<code>nginx</code>的很多命令，要想使用这些命令前提是需要进入sbin目录下才能使用，很不方便，如何去优化，我们可以将该二进制可执行文件加入到系统的环境变量，这样的话在任何目录都可以使用nginx对应的相关命令。具体实现步骤如下:</p> <p>演示可删除</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/usr/local/nginx/sbin/nginx -V
cd /usr/local/nginx/sbin  nginx -V
如何优化？？？
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>(1)修改<code>/etc/profile</code>文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /etc/profile
在最后一行添加
export PATH=$PATH:/usr/local/nginx/sbin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>(2)使之立即生效</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>source /etc/profile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>(3)执行nginx命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nginx -V
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="nginx静态资源部署"><a href="#nginx静态资源部署" class="header-anchor">#</a> Nginx静态资源部署</h2> <h3 id="nginx静态资源概述"><a href="#nginx静态资源概述" class="header-anchor">#</a> Nginx静态资源概述</h3> <p>上网去搜索访问资源对于我们来说并不陌生，通过浏览器发送一个HTTP请求实现从客户端发送请求到服务器端获取所需要内容后并把内容回显展示在页面的一个过程。这个时候，我们所请 求的内容就分为两种类型，一类是静态资源、一类是动态资源。
静态资源即指在服务器端真实存在并且能直接拿来展示的一些文件，比如常见的html页面、css文件、js文件、图 片、视频等资源；
动态资源即指在服务器端真实存在但是要想获取需要经过一定的业务逻辑处理，根据不同的条件展示在页面不同这 一部分内容，比如说报表数据展示、根据当前登录用户展示相关具体数据等资源；</p> <p>Nginx处理静态资源的内容，我们需要考虑下面这几个问题：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>（1）静态资源的配置指令
（2）静态资源的配置优化
（3）静态资源的压缩配置指令
（4）静态资源的缓存处理
（5）静态资源的访问控制，包括跨域问题和防盗链问题
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="nginx静态资源的配置指令"><a href="#nginx静态资源的配置指令" class="header-anchor">#</a> Nginx静态资源的配置指令</h3> <h4 id="listen指令"><a href="#listen指令" class="header-anchor">#</a> listen指令</h4> <p>listen:用来配置监听端口。</p> <table><thead><tr><th>语法</th> <th>listen address[:port] [default_server]...;<br>listen port [default_server]...;</th></tr></thead> <tbody><tr><td>默认值</td> <td>listen *:80 | *:8000</td></tr> <tr><td>位置</td> <td>server</td></tr></tbody></table> <p>listen的设置比较灵活，我们通过几个例子来把常用的设置方式熟悉下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>listen 127.0.0.1:8000; // listen localhost:8000 监听指定的IP和端口
listen 127.0.0.1;	监听指定IP的所有端口
listen 8000;	监听指定端口上的连接
listen *:8000;	监听指定端口上的连接
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>default_server属性是标识符，用来将此虚拟主机设置成默认主机。所谓的默认主机指的是如果没有匹配到对应的address:port，则会默认执行的。如果不指定默认使用的是第一个server。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	listen 8080;
	server_name 127.0.0.1;
	location /{
		root html;
		index index.html;
	}
}
server{
	listen 8080 default_server;
	server_name localhost;
	default_type text/plain;
	return 444 'This is a error request';
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="server-name指令"><a href="#server-name指令" class="header-anchor">#</a> server_name指令</h4> <p>server_name：用来设置虚拟主机服务名称。</p> <p>127.0.0.1 、 localhost 、域名[www.baidu.com | www.jd.com]</p> <table><thead><tr><th>语法</th> <th>server_name  name ...;<br>name可以提供多个中间用空格分隔</th></tr></thead> <tbody><tr><td>默认值</td> <td>server_name  &quot;&quot;;</td></tr> <tr><td>位置</td> <td>server</td></tr></tbody></table> <p>关于server_name的配置方式有三种，分别是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>精确匹配
通配符匹配
正则表达式匹配
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>配置方式一：精确匹配</p> <p>如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name www.itcast.cn www.itheima.cn;
	...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>补充小知识点:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>hosts是一个没有扩展名的系统文件，可以用记事本等工具打开，其作用就是将一些常用的网址域名与其对应的IP地址建立一个关联“数据库”，当用户在浏览器中输入一个需要登录的网址时，系统会首先自动从hosts文件中寻找对应的IP地址，一旦找到，系统会立即打开对应网页，如果没有找到，则系统会再将网址提交DNS域名解析服务器进行IP地址的解析。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>windows:C:\Windows\System32\drivers\etc</p> <p>centos：/etc/hosts</p> <p>因为域名是要收取一定的费用，所以我们可以使用修改hosts文件来制作一些虚拟域名来使用。需要修改 <code>/etc/hosts</code>文件来添加</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /etc/hosts
127.0.0.1 www.itcast.cn
127.0.0.1 www.itheima.cn
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>配置方式二:使用通配符配置</p> <p>server_name中支持通配符&quot;*&quot;,但需要注意的是通配符不能出现在域名的中间，只能出现在首段或尾段，如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name  *.itcast.cn	www.itheima.*;
	# www.itcast.cn abc.itcast.cn www.itheima.cn www.itheima.com
	...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>下面的配置就会报错</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name  www.*.cn www.itheima.c*
	...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>配置三:使用正则表达式配置</p> <p>server_name中可以使用正则表达式，并且使用<code>~</code>作为正则表达式字符串的开始标记。</p> <p>常见的正则表达式</p> <table><thead><tr><th>代码</th> <th>说明</th></tr></thead> <tbody><tr><td>^</td> <td>匹配搜索字符串开始位置</td></tr> <tr><td>$</td> <td>匹配搜索字符串结束位置</td></tr> <tr><td>.</td> <td>匹配除换行符\n之外的任何单个字符</td></tr> <tr><td>\</td> <td>转义字符，将下一个字符标记为特殊字符</td></tr> <tr><td>[xyz]</td> <td>字符集，与任意一个指定字符匹配</td></tr> <tr><td>[a-z]</td> <td>字符范围，匹配指定范围内的任何字符</td></tr> <tr><td>\w</td> <td>与以下任意字符匹配 A-Z a-z 0-9 和下划线,等效于[A-Za-z0-9_]</td></tr> <tr><td>\d</td> <td>数字字符匹配，等效于[0-9]</td></tr> <tr><td>{n}</td> <td>正好匹配n次</td></tr> <tr><td>{n,}</td> <td>至少匹配n次</td></tr> <tr><td>{n,m}</td> <td>匹配至少n次至多m次</td></tr> <tr><td>*</td> <td>零次或多次，等效于{0,}</td></tr> <tr><td>+</td> <td>一次或多次，等效于{1,}</td></tr> <tr><td>?</td> <td>零次或一次，等效于{0,1}</td></tr></tbody></table> <p>配置如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
        listen 80;
        server_name ~^www\.(\w+)\.com$;
        default_type text/plain;
        return 200 $1  $2 ..;
}
注意 ~后面不能加空格，括号可以取值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="匹配执行顺序"><a href="#匹配执行顺序" class="header-anchor">#</a> 匹配执行顺序</h5> <p>由于server_name指令支持通配符和正则表达式，因此在包含多个虚拟主机的配置文件中，可能会出现一个名称被多个虚拟主机的server_name匹配成功，当遇到这种情况，当前的请求交给谁来处理呢？</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	listen 80;
	server_name ~^www\.\w+\.com$;
	default_type text/plain;
	return 200 'regex_success';
}

server{
	listen 80;
	server_name www.itheima.*;
	default_type text/plain;
	return 200 'wildcard_after_success';
}

server{
	listen 80;
	server_name *.itheima.com;
	default_type text/plain;
	return 200 'wildcard_before_success';
}

server{
	listen 80;
	server_name www.itheima.com;
	default_type text/plain;
	return 200 'exact_success';
}

server{
	listen 80 default_server;
	server_name _;
	default_type text/plain;
	return 444 'default_server not found server';
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>结论：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>exact_success
wildcard_before_success
wildcard_after_success
regex_success
default_server not found server!!
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>No1:准确匹配server_name

No2:通配符在开始时匹配server_name成功

No3:通配符在结束时匹配server_name成功

No4:正则表达式匹配server_name成功

No5:被默认的default_server处理，如果没有指定默认找第一个server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="location指令"><a href="#location指令" class="header-anchor">#</a> location指令</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	listen 80;
	server_name localhost;
	location / {
	
	}
	location /abc{
	
	}
	...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>location:用来设置请求的URI</p> <table><thead><tr><th>语法</th> <th>location [  =  |   ~  |  ~*   |   ^~   |@ ] uri{...}</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server,location</td></tr></tbody></table> <p>uri变量是待匹配的请求字符串，可以不包含正则表达式，也可以包含正则表达式，那么nginx服务器在搜索匹配location的时候，是先使用不包含正则表达式进行匹配，找到一个匹配度最高的一个，然后在通过包含正则表达式的进行匹配，如果能匹配到直接访问，匹配不到，就使用刚才匹配度最高的那个location来处理请求。</p> <p>属性介绍:</p> <p>不带符号，要求必须以指定模式开始</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name 127.0.0.1;
	location /abc{
		default_type text/plain;
		return 200 &quot;access success&quot;;
	}
}
以下访问都是正确的
http://192.168.200.133/abc
http://192.168.200.133/abc?p1=TOM
http://192.168.200.133/abc/
http://192.168.200.133/abcdef
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>= :  用于不包含正则表达式的uri前，必须与指定的模式精确匹配</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name 127.0.0.1;
	location =/abc{
		default_type text/plain;
		return 200 &quot;access success&quot;;
	}
}
可以匹配到
http://192.168.200.133/abc
http://192.168.200.133/abc?p1=TOM
匹配不到
http://192.168.200.133/abc/
http://192.168.200.133/abcdef
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>~ ： 用于表示当前uri中包含了正则表达式，并且区分大小写
~*:  用于表示当前uri中包含了正则表达式，并且不区分大小写</p> <p>换句话说，如果uri包含了正则表达式，需要用上述两个符合来标识</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name 127.0.0.1;
	location ~^/abc\w${
		default_type text/plain;
		return 200 &quot;access success&quot;;
	}
}
server {
	listen 80;
	server_name 127.0.0.1;
	location ~*^/abc\w${
		default_type text/plain;
		return 200 &quot;access success&quot;;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>^~: 用于不包含正则表达式的uri前，功能和不加符号的一致，唯一不同的是，如果模式匹配，那么就停止搜索其他模式了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name 127.0.0.1;
	location ^~/abc{
		default_type text/plain;
		return 200 &quot;access success&quot;;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="设置请求资源的目录root-alias"><a href="#设置请求资源的目录root-alias" class="header-anchor">#</a> 设置请求资源的目录root / alias</h4> <p>root：设置请求的根目录</p> <table><thead><tr><th>语法</th> <th>root path;</th></tr></thead> <tbody><tr><td>默认值</td> <td>root html;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>path为Nginx服务器接收到请求以后查找资源的根目录路径。</p> <p>alias：用来更改location的URI</p> <table><thead><tr><th>语法</th> <th>alias path;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>location</td></tr></tbody></table> <p>path为修改后的根路径。</p> <p>以上两个指令都可以来指定访问资源的路径，那么这两者之间的区别是什么?</p> <p>举例说明：</p> <p>（1）在<code>/usr/local/nginx/html</code>目录下创建一个 images目录,并在目录下放入一张图片<code>mv.png</code>图片</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /images {
	root /usr/local/nginx/html;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>访问图片的路径为:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://192.168.200.133/images/mv.png
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>（2）如果把root改为alias</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /images {
	alias /usr/local/nginx/html;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>再次访问上述地址，页面会出现404的错误，查看错误日志会发现是因为地址不对，所以验证了：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>root的处理结果是: root路径+location路径
/usr/local/nginx/html/images/mv.png
alias的处理结果是:使用alias路径替换location路径
/usr/local/nginx/html/images
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>需要在alias后面路径改为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /images {
	alias /usr/local/nginx/html/images;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>（3）如果location路径是以/结尾,则alias也必须是以/结尾，root没有要求</p> <p>将上述配置修改为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /images/ {
	alias /usr/local/nginx/html/images;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>访问就会出问题，查看错误日志还是路径不对，所以需要把alias后面加上 /</p> <p>小结：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>root的处理结果是: root路径+location路径
alias的处理结果是:使用alias路径替换location路径
alias是一个目录别名的定义，root则是最上层目录的含义。
如果location路径是以/结尾,则alias也必须是以/结尾，root没有要求
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="index指令"><a href="#index指令" class="header-anchor">#</a> index指令</h4> <p>index:设置网站的默认首页</p> <table><thead><tr><th>语法</th> <th>index file ...;</th></tr></thead> <tbody><tr><td>默认值</td> <td>index index.html;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>index后面可以跟多个设置，如果访问的时候没有指定具体访问的资源，则会依次进行查找，找到第一个为止。</p> <p>举例说明：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location / {
	root /usr/local/nginx/html;
	index index.html index.htm;
}
访问该location的时候，可以通过 http://ip:port/，地址后面如果不添加任何内容，则默认依次访问index.html和index.htm，找到第一个来进行返回
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="error-page指令"><a href="#error-page指令" class="header-anchor">#</a> error_page指令</h4> <p>error_page:设置网站的错误页面</p> <table><thead><tr><th>语法</th> <th>error_page code ... [=[response]] uri;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>http、server、location......</td></tr></tbody></table> <p>当出现对应的响应code后，如何来处理。</p> <p>举例说明：</p> <p>（1）可以指定具体跳转的地址</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	error_page 404 http://www.itcast.cn;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>（2）可以指定重定向地址</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	error_page 404 /50x.html;
	error_page 500 502 503 504 /50x.html;
	location =/50x.html{
		root html;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>（3）使用location的@符合完成错误信息展示</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	error_page 404 @jump_to_error;
	location @jump_to_error {
		default_type text/plain;
		return 404 'Not Found Page...';
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可选项<code>=[response]</code>的作用是用来将相应代码更改为另外一个</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	error_page 404 =200 /50x.html;
	location =/50x.html{
		root html;
	}
}
这样的话，当返回404找不到对应的资源的时候，在浏览器上可以看到，最终返回的状态码是200，这块需要注意下，编写error_page后面的内容，404后面需要加空格，200前面不能加空格
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="静态资源优化配置语法"><a href="#静态资源优化配置语法" class="header-anchor">#</a> 静态资源优化配置语法</h3> <p>Nginx对静态资源如何进行优化配置。这里从三个属性配置进行优化：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>sendfile on;
tcp_nopush on;
tcp_nodeplay on;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>（1）sendﬁle，用来开启高效的文件传输模式。</p> <table><thead><tr><th>语法</th> <th>sendﬁle on |oﬀ;</th></tr></thead> <tbody><tr><td>默认值</td> <td>sendﬁle oﬀ;</td></tr> <tr><td>位置</td> <td>http、server、location...</td></tr></tbody></table> <p>请求静态资源的过程：客户端通过网络接口向服务端发送请求，操作系统将这些客户端的请求传递给服务器端应用程序，服务器端应用程序会处理这些请求，请求处理完成以后，操作系统还需要将处理得到的结果通过网络适配器传递回去。</p> <p>如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name localhost；
	location / {
		root html;
		index index.html;
	}
}
在html目录下有一个welcome.html页面，访问地址
http://192.168.200.133/welcome.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587655397104.png" alt="1587655397104"></p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587665814562.png" alt="1587665814562"></p> <p>（2）tcp_nopush：该指令必须在sendfile打开的状态下才会生效，主要是用来提升网络包的传输'效率'</p> <table><thead><tr><th>语法</th> <th>tcp_nopush on|off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>tcp_nopush oﬀ;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>（3）tcp_nodelay：该指令必须在keep-alive连接开启的情况下才生效，来提高网络包传输的'实时性'</p> <table><thead><tr><th>语法</th> <th>tcp_nodelay on|off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>tcp_nodelay on;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587832596733.png" alt="1587832596733"></p> <p>经过刚才的分析，&quot;tcp_nopush&quot;和”tcp_nodelay“看起来是&quot;互斥的&quot;，那么为什么要将这两个值都打开，这个大家需要知道的是在linux2.5.9以后的版本中两者是可以兼容的，三个指令都开启的好处是，sendfile可以开启高效的文件传输模式，tcp_nopush开启可以确保在发送到客户端之前数据包已经充分“填满”， 这大大减少了网络开销，并加快了文件发送的速度。 然后，当它到达最后一个可能因为没有“填满”而暂停的数据包时，Nginx会忽略tcp_nopush参数， 然后，tcp_nodelay强制套接字发送数据。由此可知，TCP_NOPUSH可以与TCP_NODELAY一起设置，它比单独配置TCP_NODELAY具有更强的性能。所以我们可以使用如下配置来优化Nginx静态资源的处理</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>sendfile on;
tcp_nopush on;
tcp_nodelay on;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="nginx静态资源压缩实战"><a href="#nginx静态资源压缩实战" class="header-anchor">#</a> Nginx静态资源压缩实战</h3> <p>经过上述内容的优化，我们再次思考一个问题，假如在满足上述优化的前提下，我们传送一个1M的数据和一个10M的数据那个效率高?，答案显而易见，传输内容小，速度就会快。那么问题又来了，同样的内容，如果把大小降下来，我们脑袋里面要蹦出一个词就是&quot;压缩&quot;，接下来，我们来学习Nginx的静态资源压缩模块。</p> <p>在Nginx的配置文件中可以通过配置gzip来对静态资源进行压缩，相关的指令可以配置在http块、server块和location块中，Nginx可以通过</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ngx_http_gzip_module模块
ngx_http_gzip_static_module模块
ngx_http_gunzip_module模块
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>对这些指令进行解析和处理。</p> <p>接下来我们从以下内容进行学习</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>（1）Gzip各模块支持的配置指令
（2）Gzip压缩功能的配置
（3）Gzip和sendfile的冲突解决
（4）浏览器不支持Gzip的解决方案
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="gzip模块配置指令"><a href="#gzip模块配置指令" class="header-anchor">#</a> Gzip模块配置指令</h4> <p>接下来所学习的指令都来自ngx_http_gzip_module模块，该模块会在nginx安装的时候内置到nginx的安装环境中，也就是说我们可以直接使用这些指令。</p> <ol><li>gzip指令：该指令用于开启或者关闭gzip功能</li></ol> <table><thead><tr><th>语法</th> <th>gzip on|off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>gzip off;</td></tr> <tr><td>位置</td> <td>http、server、location...</td></tr></tbody></table> <p>注意只有该指令为打开状态，下面的指令才有效果</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http{
   gzip on;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>gzip_types指令：该指令可以根据响应页的MIME类型选择性地开启Gzip压缩功能</li></ol> <table><thead><tr><th>语法</th> <th>gzip_types mime-type ...;</th></tr></thead> <tbody><tr><td>默认值</td> <td>gzip_types text/html;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>所选择的值可以从mime.types文件中进行查找，也可以使用&quot;*&quot;代表所有。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http{
	gzip_types application/javascript;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="3"><li>gzip_comp_level指令：该指令用于设置Gzip压缩程度，级别从1-9,1表示要是程度最低，要是效率最高，9刚好相反，压缩程度最高，但是效率最低最费时间。</li></ol> <table><thead><tr><th>语法</th> <th>gzip_comp_level level;</th></tr></thead> <tbody><tr><td>默认值</td> <td>gzip_comp_level 1;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>http{
	gzip_comp_level 6;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="4"><li>gzip_vary指令：该指令用于设置使用Gzip进行压缩发送是否携带“Vary:Accept-Encoding”头域的响应头部。主要是告诉接收方，所发送的数据经过了Gzip压缩处理</li></ol> <table><thead><tr><th>语法</th> <th>gzip_vary on|off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>gzip_vary off;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587361606028.png" alt="1587361606028"></p> <ol start="5"><li>gzip_buffers指令：该指令用于处理请求压缩的缓冲区数量和大小。</li></ol> <table><thead><tr><th>语法</th> <th>gzip_buffers number size;</th></tr></thead> <tbody><tr><td>默认值</td> <td>gzip_buffers 32 4k|16 8k;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>其中number:指定Nginx服务器向系统申请缓存空间个数，size指的是每个缓存空间的大小。主要实现的是申请number个每个大小为size的内存空间。这个值的设定一般会和服务器的操作系统有关，所以建议此项不设置，使用默认值即可。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>gzip_buffers 4 16K;	  #缓存空间大小
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="6"><li>gzip_disable指令：针对不同种类客户端发起的请求，可以选择性地开启和关闭Gzip功能。</li></ol> <table><thead><tr><th>语法</th> <th>gzip_disable regex ...;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>regex:根据客户端的浏览器标志(user-agent)来设置，支持使用正则表达式。指定的浏览器标志不使用Gzip.该指令一般是用来排除一些明显不支持Gzip的浏览器。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>gzip_disable &quot;MSIE [1-6]\.&quot;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="7"><li>gzip_http_version指令：针对不同的HTTP协议版本，可以选择性地开启和关闭Gzip功能。</li></ol> <table><thead><tr><th>语法</th> <th>gzip_http_version 1.0|1.1;</th></tr></thead> <tbody><tr><td>默认值</td> <td>gzip_http_version 1.1;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>该指令是指定使用Gzip的HTTP最低版本，该指令一般采用默认值即可。</p> <ol start="8"><li>gzip_min_length指令：该指令针对传输数据的大小，可以选择性地开启和关闭Gzip功能</li></ol> <table><thead><tr><th>语法</th> <th>gzip_min_length length;</th></tr></thead> <tbody><tr><td>默认值</td> <td>gzip_min_length 20;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>nignx计量大小的单位：bytes[字节] / kb[千字节] / M[兆]
例如: 1024 / 10k|K / 10m|M
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Gzip压缩功能对大数据的压缩效果明显，但是如果要压缩的数据比较小的化，可能出现越压缩数据量越大的情况，因此我们需要根据响应内容的大小来决定是否使用Gzip功能，响应页面的大小可以通过头信息中的<code>Content-Length</code>来获取。但是如何使用了Chunk编码动态压缩，该指令将被忽略。建议设置为1K或以上。</p> <ol start="9"><li>gzip_proxied指令：该指令设置是否对服务端返回的结果进行Gzip压缩。</li></ol> <table><thead><tr><th>语法</th> <th>gzip_proxied  off|expired|no-cache|<br>no-store|private|no_last_modified|no_etag|auth|any;</th></tr></thead> <tbody><tr><td>默认值</td> <td>gzip_proxied off;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>off - 关闭Nginx服务器对后台服务器返回结果的Gzip压缩
expired - 启用压缩，如果header头中包含 &quot;Expires&quot; 头信息
no-cache - 启用压缩，如果header头中包含 &quot;Cache-Control:no-cache&quot; 头信息
no-store - 启用压缩，如果header头中包含 &quot;Cache-Control:no-store&quot; 头信息
private - 启用压缩，如果header头中包含 &quot;Cache-Control:private&quot; 头信息
no_last_modified - 启用压缩,如果header头中不包含 &quot;Last-Modified&quot; 头信息
no_etag - 启用压缩 ,如果header头中不包含 &quot;ETag&quot; 头信息
auth - 启用压缩 , 如果header头中包含 &quot;Authorization&quot; 头信息
any - 无条件启用压缩</p> <h4 id="gzip压缩功能的实例配置"><a href="#gzip压缩功能的实例配置" class="header-anchor">#</a> Gzip压缩功能的实例配置</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>gzip on;  			  #开启gzip功能
gzip_types *;		  #压缩源文件类型,根据具体的访问资源类型设定
gzip_comp_level 6;	  #gzip压缩级别
gzip_min_length 1024; #进行压缩响应页面的最小长度,content-length
gzip_buffers 4 16K;	  #缓存空间大小
gzip_http_version 1.1; #指定压缩响应所需要的最低HTTP请求版本
gzip_vary  on;		  #往头信息中添加压缩标识
gzip_disable &quot;MSIE [1-6]\.&quot;; #对IE6以下的版本都不进行压缩
gzip_proxied  off； #nginx作为反向代理压缩服务端返回数据的条件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这些配置在很多地方可能都会用到，所以我们可以将这些内容抽取到一个配置文件中，然后通过include指令把配置文件再次加载到nginx.conf配置文件中，方法使用。</p> <p>nginx_gzip.conf</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>gzip on;
gzip_types *;
gzip_comp_level 6;
gzip_min_length 1024;
gzip_buffers 4 16K;
gzip_http_version 1.1;
gzip_vary  on;
gzip_disable &quot;MSIE [1-6]\.&quot;;
gzip_proxied  off;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>nginx.conf</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>include nginx_gzip.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="gzip和sendfile共存问题"><a href="#gzip和sendfile共存问题" class="header-anchor">#</a> Gzip和sendfile共存问题</h4> <p>前面在讲解sendfile的时候，提到过，开启sendfile以后，在读取磁盘上的静态资源文件的时候，可以减少拷贝的次数，可以不经过用户进程将静态文件通过网络设备发送出去，但是Gzip要想对资源压缩，是需要经过用户进程进行操作的。所以如何解决两个设置的共存问题。</p> <p>可以使用ngx_http_gzip_static_module模块的gzip_static指令来解决。</p> <h5 id="gzip-static指令"><a href="#gzip-static指令" class="header-anchor">#</a> gzip_static指令</h5> <p>gzip_static: 检查与访问资源同名的.gz文件时，response中以gzip相关的header返回.gz文件的内容。</p> <table><thead><tr><th>语法</th> <th><strong>gzip_static</strong> on | off | always;</th></tr></thead> <tbody><tr><td>默认值</td> <td>gzip_static off;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>添加上述命令后，会报一个错误，<code>unknown directive &quot;gzip_static&quot;</code>主要的原因是Nginx默认是没有添加ngx_http_gzip_static_module模块。如何来添加?</p> <h5 id="添加模块到nginx的实现步骤"><a href="#添加模块到nginx的实现步骤" class="header-anchor">#</a> 添加模块到Nginx的实现步骤</h5> <p>(1)查询当前Nginx的配置参数</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nginx -V
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>(2)将nginx安装目录下sbin目录中的nginx二进制文件进行更名</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/nginx/sbin
mv nginx nginxold
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>(3) 进入Nginx的安装目录</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /root/nginx/core/nginx-1.16.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>(4)执行make clean清空之前编译的内容</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make clean
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>(5)使用configure来配置参数</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>./configure --with-http_gzip_static_module
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>(6)使用make命令进行编译</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>(7) 将objs目录下的nginx二进制执行文件移动到nginx安装目录下的sbin目录中</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mv objs/nginx /usr/local/nginx/sbin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>(8)执行更新命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make upgrade
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="gzip-static测试使用"><a href="#gzip-static测试使用" class="header-anchor">#</a> gzip_static测试使用</h5> <p>(1)直接访问<code>http://192.168.200.133/jquery.js</code></p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587932106429.png" alt="1587932106429"></p> <p>(2)使用gzip命令进行压缩</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/nginx/html
gzip jquery.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>(3)再次访问<code>http://192.168.200.133/jquery.js</code></p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1587932300006.png" alt="1587932300006"></p> <h3 id="静态资源的缓存处理"><a href="#静态资源的缓存处理" class="header-anchor">#</a> 静态资源的缓存处理</h3> <h4 id="什么是缓存"><a href="#什么是缓存" class="header-anchor">#</a> 什么是缓存</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>缓存（cache），原始意义是指访问速度比一般随机存取存储器（RAM）快的一种高速存储器，通常它不像系统主存那样使用DRAM技术，而使用昂贵但较快速的SRAM技术。缓存的设置是所有现代计算机系统发挥高性能的重要因素之一。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="什么是web缓存"><a href="#什么是web缓存" class="header-anchor">#</a> 什么是web缓存</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>Web缓存是指一个Web资源（如html页面，图片，js，数据等）存在于Web服务器和客户端（浏览器）之间的副本。缓存会根据进来的请求保存输出内容的副本；当下一个请求来到的时候，如果是相同的URL，缓存会根据缓存机制决定是直接使用副本响应访问请求，还是向源服务器再次发送请求。比较常见的就是浏览器会缓存访问过网站的网页，当再次访问这个URL地址的时候，如果网页没有更新，就不会再次下载网页，而是直接使用本地缓存的网页。只有当网站明确标识资源已经更新，浏览器才会再次下载网页
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="web缓存的种类"><a href="#web缓存的种类" class="header-anchor">#</a> web缓存的种类</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>客户端缓存
	浏览器缓存
服务端缓存
	Nginx / Redis / Memcached等
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="浏览器缓存"><a href="#浏览器缓存" class="header-anchor">#</a> 浏览器缓存</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>是为了节约网络的资源加速浏览，浏览器在用户磁盘上对最近请求过的文档进行存储，当访问者再次请求这个页面时，浏览器就可以从本地磁盘显示文档，这样就可以加速页面的阅览.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="为什么要用浏览器缓存"><a href="#为什么要用浏览器缓存" class="header-anchor">#</a> 为什么要用浏览器缓存</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>成本最低的一种缓存实现
减少网络带宽消耗
降低服务器压力
减少网络延迟，加快页面打开速度
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="浏览器缓存的执行流程"><a href="#浏览器缓存的执行流程" class="header-anchor">#</a> 浏览器缓存的执行流程</h4> <p>HTTP协议中和页面缓存相关的字段，我们先来认识下：</p> <table><thead><tr><th>header</th> <th>说明</th></tr></thead> <tbody><tr><td>Expires</td> <td>缓存过期的日期和时间</td></tr> <tr><td>Cache-Control</td> <td>设置和缓存相关的配置信息</td></tr> <tr><td>Last-Modified</td> <td>请求资源最后修改时间</td></tr> <tr><td>ETag</td> <td>请求变量的实体标签的当前值，比如文件的MD5值</td></tr></tbody></table> <h4 id=""><a href="#" class="header-anchor">#</a></h4> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1581762832290.png" alt=""></p> <p>（1）用户首次通过浏览器发送请求到服务端获取数据，客户端是没有对应的缓存，所以需要发送request请求来获取数据；</p> <p>（2）服务端接收到请求后，获取服务端的数据及服务端缓存的允许后，返回200的成功状态码并且在响应头上附上对应资源以及缓存信息；</p> <p>（3）当用户再次访问相同资源的时候，客户端会在浏览器的缓存目录中查找是否存在响应的缓存文件</p> <p>（4）如果没有找到对应的缓存文件，则走(2)步</p> <p>（5）如果有缓存文件，接下来对缓存文件是否过期进行判断，过期的判断标准是(Expires),</p> <p>（6）如果没有过期，则直接从本地缓存中返回数据进行展示</p> <p>（7）如果Expires过期，接下来需要判断缓存文件是否发生过变化</p> <p>（8）判断的标准有两个，一个是ETag(Entity Tag),一个是Last-Modified</p> <p>（9）判断结果是未发生变化，则服务端返回304，直接从缓存文件中获取数据</p> <p>（10）如果判断是发生了变化，重新从服务端获取数据，并根据缓存协商(服务端所设置的是否需要进行缓存数据的设置)来进行数据缓存。</p> <h4 id="浏览器缓存相关指令"><a href="#浏览器缓存相关指令" class="header-anchor">#</a> 浏览器缓存相关指令</h4> <p>Nginx需要进行缓存相关设置，就需要用到如下的指令</p> <h5 id="expires指令"><a href="#expires指令" class="header-anchor">#</a> expires指令</h5> <p>expires:该指令用来控制页面缓存的作用。可以通过该指令控制HTTP应答中的“Expires&quot;和”Cache-Control&quot;</p> <table><thead><tr><th>语法</th> <th>expires   [modified] time<br>expires epoch|max|off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>expires off;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>time:可以整数也可以是负数，指定过期时间，如果是负数，Cache-Control则为no-cache,如果为整数或0，则Cache-Control的值为max-age=time;</p> <p>epoch: 指定Expires的值为'1 January,1970,00:00:01 GMT'(1970-01-01 00:00:00)，Cache-Control的值no-cache</p> <p>max:指定Expires的值为'31 December2037 23:59:59GMT' (2037-12-31 23:59:59) ，Cache-Control的值为10年</p> <p>off:默认不缓存。</p> <h5 id="add-header指令"><a href="#add-header指令" class="header-anchor">#</a> add_header指令</h5> <p>add_header指令是用来添加指定的响应头和响应值。</p> <table><thead><tr><th>语法</th> <th>add_header name value [always];</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>http、server、location...</td></tr></tbody></table> <p>Cache-Control作为响应头信息，可以设置如下值：</p> <p>缓存响应指令：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Cache-control: must-revalidate
Cache-control: no-cache
Cache-control: no-store
Cache-control: no-transform
Cache-control: public
Cache-control: private
Cache-control: proxy-revalidate
Cache-Control: max-age=&lt;seconds&gt;
Cache-control: s-maxage=&lt;seconds&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><table><thead><tr><th>指令</th> <th>说明</th></tr></thead> <tbody><tr><td>must-revalidate</td> <td>可缓存但必须再向源服务器进行确认</td></tr> <tr><td>no-cache</td> <td>缓存前必须确认其有效性</td></tr> <tr><td>no-store</td> <td>不缓存请求或响应的任何内容</td></tr> <tr><td>no-transform</td> <td>代理不可更改媒体类型</td></tr> <tr><td>public</td> <td>可向任意方提供响应的缓存</td></tr> <tr><td>private</td> <td>仅向特定用户返回响应</td></tr> <tr><td>proxy-revalidate</td> <td>要求中间缓存服务器对缓存的响应有效性再进行确认</td></tr> <tr><td>max-age=&lt;秒&gt;</td> <td>响应最大Age值</td></tr> <tr><td>s-maxage=&lt;秒&gt;</td> <td>公共缓存服务器响应的最大Age值</td></tr></tbody></table> <p>max-age=[秒]：</p> <h3 id="nginx的跨域问题解决"><a href="#nginx的跨域问题解决" class="header-anchor">#</a> Nginx的跨域问题解决</h3> <p>这块内容，我们主要从以下方面进行解决：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>什么情况下会出现跨域问题?
实例演示跨域问题
具体的解决方案是什么?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="同源策略"><a href="#同源策略" class="header-anchor">#</a> 同源策略</h4> <p>浏览器的同源策略：是一种约定，是浏览器最核心也是最基本的安全功能，如果浏览器少了同源策略，则浏览器的正常功能可能都会受到影响。</p> <p>同源:  协议、域名(IP)、端口相同即为同源</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://192.168.200.131/user/1
https://192.168.200.131/user/1
不

http://192.168.200.131/user/1
http://192.168.200.132/user/1
不

http://192.168.200.131/user/1
http://192.168.200.131:8080/user/1
不

http://www.nginx.com/user/1
http://www.nginx.org/user/1
不

http://192.168.200.131/user/1
http://192.168.200.131:8080/user/1
不

http://www.nginx.org:80/user/1
http://www.nginx.org/user/1
满足
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="跨域问题"><a href="#跨域问题" class="header-anchor">#</a> 跨域问题</h4> <p>简单描述下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>有两台服务器分别为A,B,如果从服务器A的页面发送异步请求到服务器B获取数据，如果服务器A和服务器B不满足同源策略，则就会出现跨域问题。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="跨域问题的案例演示"><a href="#跨域问题的案例演示" class="header-anchor">#</a> 跨域问题的案例演示</h4> <p>出现跨域问题会有什么效果?,接下来通过一个需求来给大家演示下：</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1581766282200.png" alt="">（1）nginx的html目录下新建一个a.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>跨域问题演示<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jquery.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://192.168.200.133:8080/getUser'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>获取数据<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>（2）在nginx.conf配置如下内容</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
        listen  8080;
        server_name localhost;
        location /getUser{
                default_type application/json;
                return 200 '{&quot;id&quot;:1,&quot;name&quot;:&quot;TOM&quot;,&quot;age&quot;:18}';
        }
}
server{
	listen 	80;
	server_name localhost;
	location /{
		root html;
		index index.html;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>(3)通过浏览器访问测试</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1588004913681.png" alt="1588004913681"></p> <h4 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h4> <p>使用add_header指令，该指令可以用来添加一些头信息</p> <table><thead><tr><th>语法</th> <th>add_header name  value...</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>此处用来解决跨域问题，需要添加两个头信息，一个是<code>Access-Control-Allow-Origin</code>,<code>Access-Control-Allow-Methods</code></p> <p>Access-Control-Allow-Origin: 直译过来是允许跨域访问的源地址信息，可以配置多个(多个用逗号分隔)，也可以使用<code>*</code>代表所有源</p> <p>Access-Control-Allow-Methods:直译过来是允许跨域访问的请求方式，值可以为 GET POST PUT DELETE...,可以全部设置，也可以根据需要设置，多个用逗号分隔</p> <p>具体配置方式</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /getUser{
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE;
    default_type application/json;
    return 200 '{&quot;id&quot;:1,&quot;name&quot;:&quot;TOM&quot;,&quot;age&quot;:18}';
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="静态资源防盗链"><a href="#静态资源防盗链" class="header-anchor">#</a> 静态资源防盗链</h3> <h4 id="什么是资源盗链"><a href="#什么是资源盗链" class="header-anchor">#</a> 什么是资源盗链</h4> <p>资源盗链指的是此内容不在自己服务器上，而是通过技术手段，绕过别人的限制将别人的内容放到自己页面上最终展示给用户。以此来盗取大网站的空间和流量。简而言之就是用别人的东西成就自己的网站。</p> <p>效果演示</p> <p>京东:https://img14.360buyimg.com/n7/jfs/t1/101062/37/2153/254169/5dcbd410E6d10ba22/4ddbd212be225fcd.jpg</p> <p>百度:https://pics7.baidu.com/feed/cf1b9d16fdfaaf516f7e2011a7cda1e8f11f7a1a.jpeg?token=551979a23a0995e5e5279b8fa1a48b34&amp;s=BD385394D2E963072FD48543030030BB</p> <p>我们自己准备一个页面，在页面上引入这两个图片查看效果</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1581827029973.png" alt=""></p> <p>从上面的效果，可以看出来，下面的图片地址添加了防止盗链的功能，京东这边我们可以直接使用其图片。</p> <h4 id="nginx防盗链的实现原理"><a href="#nginx防盗链的实现原理" class="header-anchor">#</a> Nginx防盗链的实现原理：</h4> <p>了解防盗链的原理之前，我们得先学习一个HTTP的头信息Referer,当浏览器向web服务器发送请求的时候，一般都会带上Referer,来告诉浏览器该网页是从哪个页面链接过来的。</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1581769820325.png" alt=""></p> <p>后台服务器可以根据获取到的这个Referer信息来判断是否为自己信任的网站地址，如果是则放行继续访问，如果不是则可以返回403(服务端拒绝访问)的状态信息。</p> <p>在本地模拟上述的服务器效果：</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1581769079083.png" alt=""></p> <p>Nginx防盗链的具体实现:</p> <p>valid_referers:nginx会通就过查看referer自动和valid_referers后面的内容进行匹配，如果匹配到了就将$invalid_referer变量置0，如果没有匹配到，则将$invalid_referer变量置为1，匹配的过程中不区分大小写。</p> <table><thead><tr><th>语法</th> <th>valid_referers none|blocked|server_names|string...</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location</td></tr></tbody></table> <p>none: 如果Header中的Referer为空，允许访问</p> <p>blocked:在Header中的Referer不为空，但是该值被防火墙或代理进行伪装过，如不带&quot;http://&quot; 、&quot;https://&quot;等协议头的资源允许访问。</p> <p>server_names:指定具体的域名或者IP</p> <p>string: 可以支持正则表达式和*的字符串。如果是正则表达式，需要以<code>~</code>开头表示，例如</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location ~*\.(png|jpg|gif){
           valid_referers none blocked www.baidu.com 192.168.200.222 *.example.com example.*  www.example.org  ~\.google\.;
           if ($invalid_referer){
                return 403;
           }
           root /usr/local/nginx/html;

}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>遇到的问题:图片有很多，该如何批量进行防盗链？</p> <h4 id="针对目录进行防盗链"><a href="#针对目录进行防盗链" class="header-anchor">#</a> 针对目录进行防盗链</h4> <p>配置如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /images {
           valid_referers none blocked www.baidu.com 192.168.200.222 *.example.com example.*  www.example.org  ~\.google\.;
           if ($invalid_referer){
                return 403;
           }
           root /usr/local/nginx/html;

}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这样我们可以对一个目录下的所有资源进行翻到了操作。</p> <p>遇到的问题：Referer的限制比较粗，比如随意加一个Referer，上面的方式是无法进行限制的。那么这个问题改如何解决？</p> <p>此处我们需要用到Nginx的第三方模块<code>ngx_http_accesskey_module</code>，第三方模块如何实现盗链，如果在Nginx中使用第三方模块的功能，这些我们在后面的Nginx的模块篇再进行详细的讲解。</p> <h3 id="rewrite功能配置"><a href="#rewrite功能配置" class="header-anchor">#</a> Rewrite功能配置</h3> <p>Rewrite是Nginx服务器提供的一个重要基本功能，是Web服务器产品中几乎必备的功能。主要的作用是用来实现URL的重写。</p> <p>注意:Nginx服务器的Rewrite功能的实现依赖于PCRE的支持，因此在编译安装Nginx服务器之前，需要安装PCRE库。Nginx使用的是ngx_http_rewrite_module模块来解析和处理Rewrite功能的相关配置。</p> <h4 id="地址重写-与-地址转发"><a href="#地址重写-与-地址转发" class="header-anchor">#</a> &quot;地址重写&quot;与&quot;地址转发&quot;</h4> <p>重写和转发的区别:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>地址重写浏览器地址会发生变化而地址转发则不变
一次地址重写会产生两次请求而一次地址转发只会产生一次请求
地址重写到的页面必须是一个完整的路径而地址转发则不需要
地址重写因为是两次请求所以request范围内属性不能传递给新页面而地址转发因为是一次请求所以可以传递值
地址转发速度快于地址重写
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="rewrite规则"><a href="#rewrite规则" class="header-anchor">#</a> Rewrite规则</h4> <h4 id="set指令"><a href="#set指令" class="header-anchor">#</a> set指令</h4> <p>该指令用来设置一个新的变量。</p> <table><thead><tr><th>语法</th> <th>set $variable value;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location、if</td></tr></tbody></table> <p>variable:变量的名称，该变量名称要用&quot;$&quot;作为变量的第一个字符，且不能与Nginx服务器预设的全局变量同名。</p> <p>value:变量的值，可以是字符串、其他变量或者变量的组合等。</p> <h4 id="rewrite常用全局变量"><a href="#rewrite常用全局变量" class="header-anchor">#</a> Rewrite常用全局变量</h4> <table><thead><tr><th>变量</th> <th>说明</th></tr></thead> <tbody><tr><td>$args</td> <td>变量中存放了请求URL中的请求指令。比如http://192.168.200.133:8080?arg1=value1&amp;args2=value2中的&quot;arg1=value1&amp;arg2=value2&quot;，功能和$query_string一样</td></tr> <tr><td>$http_user_agent</td> <td>变量存储的是用户访问服务的代理信息(如果通过浏览器访问，记录的是浏览器的相关版本信息)</td></tr> <tr><td>$host</td> <td>变量存储的是访问服务器的server_name值</td></tr> <tr><td>$document_uri</td> <td>变量存储的是当前访问地址的URI。比如http://192.168.200.133/server?id=10&amp;name=zhangsan中的&quot;/server&quot;，功能和$uri一样</td></tr> <tr><td>$document_root</td> <td>变量存储的是当前请求对应location的root值，如果未设置，默认指向Nginx自带html目录所在位置</td></tr> <tr><td>$content_length</td> <td>变量存储的是请求头中的Content-Length的值</td></tr> <tr><td>$content_type</td> <td>变量存储的是请求头中的Content-Type的值</td></tr> <tr><td>$http_cookie</td> <td>变量存储的是客户端的cookie信息，可以通过add_header Set-Cookie 'cookieName=cookieValue'来添加cookie数据</td></tr> <tr><td>$limit_rate</td> <td>变量中存储的是Nginx服务器对网络连接速率的限制，也就是Nginx配置中对limit_rate指令设置的值，默认是0，不限制。</td></tr> <tr><td>$remote_addr</td> <td>变量中存储的是客户端的IP地址</td></tr> <tr><td>$remote_port</td> <td>变量中存储了客户端与服务端建立连接的端口号</td></tr> <tr><td>$remote_user</td> <td>变量中存储了客户端的用户名，需要有认证模块才能获取</td></tr> <tr><td>$scheme</td> <td>变量中存储了访问协议</td></tr> <tr><td>$server_addr</td> <td>变量中存储了服务端的地址</td></tr> <tr><td>$server_name</td> <td>变量中存储了客户端请求到达的服务器的名称</td></tr> <tr><td>$server_port</td> <td>变量中存储了客户端请求到达服务器的端口号</td></tr> <tr><td>$server_protocol</td> <td>变量中存储了客户端请求协议的版本，比如&quot;HTTP/1.1&quot;</td></tr> <tr><td>$request_body_file</td> <td>变量中存储了发给后端服务器的本地文件资源的名称</td></tr> <tr><td>$request_method</td> <td>变量中存储了客户端的请求方式，比如&quot;GET&quot;,&quot;POST&quot;等</td></tr> <tr><td>$request_filename</td> <td>变量中存储了当前请求的资源文件的路径名</td></tr> <tr><td>$request_uri</td> <td>变量中存储了当前请求的URI，并且携带请求参数，比如http://192.168.200.133/server?id=10&amp;name=zhangsan中的&quot;/server?id=10&amp;name=zhangsan&quot;</td></tr></tbody></table> <h4 id="if指令"><a href="#if指令" class="header-anchor">#</a> if指令</h4> <p>该指令用来支持条件判断，并根据条件判断结果选择不同的Nginx配置。</p> <table><thead><tr><th>语法</th> <th>if  (condition){...}</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location</td></tr></tbody></table> <p>condition为判定条件，可以支持以下写法：</p> <ol><li>变量名。如果变量名对应的值为空或者是0，if都判断为false,其他条件为true。</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>if ($param){
	
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>2. 使用&quot;=&quot;和&quot;!=&quot;比较变量和字符串是否相等，满足条件为true，不满足为false
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>if ($request_method = POST){
	return 405;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意：此处和Java不太一样的地方是字符串不需要添加引号。</p> <ol start="3"><li><p>使用正则表达式对变量进行匹配，匹配成功返回true，否则返回false。变量与正则表达式之间使用&quot;~&quot;,&quot;~*&quot;,&quot;!~&quot;,&quot;!~*&quot;来连接。</p> <p>&quot;~&quot;代表匹配正则表达式过程中区分大小写，</p> <p>&quot;~*&quot;代表匹配正则表达式过程中不区分大小写</p> <p>&quot;!~&quot;和&quot;!~*&quot;刚好和上面取相反值，如果匹配上返回false,匹配不上返回true</p></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>if ($http_user_agent ~ MSIE){
	#$http_user_agent的值中是否包含MSIE字符串，如果包含返回true
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意：正则表达式字符串一般不需要加引号，但是如果字符串中包含&quot;}&quot;或者是&quot;;&quot;等字符时，就需要把引号加上。</p> <ol start="4"><li><p>判断请求的文件是否存在使用&quot;-f&quot;和&quot;!-f&quot;,</p> <p>当使用&quot;-f&quot;时，如果请求的文件存在返回true，不存在返回false。</p> <p>当使用&quot;!f&quot;时，如果请求文件不存在，但该文件所在目录存在返回true,文件和目录都不存在返回false,如果文件存在返回false</p></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>if (-f $request_filename){
	#判断请求的文件是否存在
}
if (!-f $request_filename){
	#判断请求的文件是否不存在
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="5"><li><p>判断请求的目录是否存在使用&quot;-d&quot;和&quot;!-d&quot;,</p> <p>当使用&quot;-d&quot;时，如果请求的目录存在，if返回true，如果目录不存在则返回false</p> <p>当使用&quot;!-d&quot;时，如果请求的目录不存在但该目录的上级目录存在则返回true，该目录和它上级目录都不存在则返回false,如果请求目录存在也返回false.</p></li> <li><p>判断请求的目录或者文件是否存在使用&quot;-e&quot;和&quot;!-e&quot;</p> <p>当使用&quot;-e&quot;,如果请求的目录或者文件存在时，if返回true,否则返回false.</p> <p>当使用&quot;!-e&quot;,如果请求的文件和文件所在路径上的目录都不存在返回true,否则返回false</p></li> <li><p>判断请求的文件是否可执行使用&quot;-x&quot;和&quot;!-x&quot;</p> <p>当使用&quot;-x&quot;,如果请求的文件可执行，if返回true,否则返回false</p> <p>当使用&quot;!-x&quot;,如果请求文件不可执行，返回true,否则返回false</p></li></ol> <h4 id="break指令"><a href="#break指令" class="header-anchor">#</a> break指令</h4> <p>该指令用于中断当前相同作用域中的其他Nginx配置。与该指令处于同一作用域的Nginx配置中，位于它前面的指令配置生效，位于后面的指令配置无效。</p> <table><thead><tr><th>语法</th> <th>break;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location、if</td></tr></tbody></table> <p>例子:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /{
	if ($param){
		set $id $1;
		break;
		limit_rate 10k;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="return指令"><a href="#return指令" class="header-anchor">#</a> return指令</h4> <p>该指令用于完成对请求的处理，直接向客户端返回响应状态代码。在return后的所有Nginx配置都是无效的。</p> <table><thead><tr><th>语法</th> <th>return code [text];<br>return code URL;<br>return URL;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location、if</td></tr></tbody></table> <p>code:为返回给客户端的HTTP状态代理。可以返回的状态代码为0~999的任意HTTP状态代理</p> <p>text:为返回给客户端的响应体内容，支持变量的使用</p> <p>URL:为返回给客户端的URL地址</p> <h4 id="rewrite指令"><a href="#rewrite指令" class="header-anchor">#</a> rewrite指令</h4> <p>该指令通过正则表达式的使用来改变URI。可以同时存在一个或者多个指令，按照顺序依次对URL进行匹配和处理。</p> <p>URL和URI的区别：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>URI:统一资源标识符
URL:统一资源定位符
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><table><thead><tr><th>语法</th> <th>rewrite regex replacement [flag];</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location、if</td></tr></tbody></table> <p>regex:用来匹配URI的正则表达式</p> <p>replacement:匹配成功后，用于替换URI中被截取内容的字符串。如果该字符串是以&quot;http://&quot;或者&quot;https://&quot;开头的，则不会继续向下对URI进行其他处理，而是直接返回重写后的URI给客户端。</p> <p>flag:用来设置rewrite对URI的处理行为，可选值有如下：</p> <ul><li>last:</li> <li>break</li> <li>redirect</li> <li>permanent</li></ul> <h4 id="rewrite-log指令"><a href="#rewrite-log指令" class="header-anchor">#</a> rewrite_log指令</h4> <p>该指令配置是否开启URL重写日志的输出功能。</p> <table><thead><tr><th>语法</th> <th>rewrite_log on|off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>rewrite_log off;</td></tr> <tr><td>位置</td> <td>http、server、location、if</td></tr></tbody></table> <p>开启后，URL重写的相关日志将以notice级别输出到error_log指令配置的日志文件汇总。</p> <h3 id="rewrite的案例"><a href="#rewrite的案例" class="header-anchor">#</a> Rewrite的案例</h3> <h4 id="域名跳转"><a href="#域名跳转" class="header-anchor">#</a> 域名跳转</h4> <p>》问题分析</p> <p>先来看一个效果，如果我们想访问京东网站，大家都知道我们可以输入<code>www.jd.com</code>,但是同样的我们也可以输入<code>www.360buy.com</code>同样也都能访问到京东网站。这个其实是因为京东刚开始的时候域名就是www.360buy.com，后面由于各种原因把自己的域名换成了www.jd.com, 虽然说域名变量，但是对于以前只记住了www.360buy.com的用户来说，我们如何把这部分用户也迁移到我们新域名的访问上来，针对于这个问题，我们就可以使用Nginx中Rewrite的域名跳转来解决。</p> <p>》环境准备</p> <ul><li>准备两个域名  www.360buy.com | www.jd.com</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /etc/hosts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>192.168.200.133 www.360buy.com
192.168.200.133 www.jd.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>在/usr/local/nginx/html/hm目录下创建一个访问页面</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;html&gt;
	&lt;title&gt;&lt;/title&gt;
	&lt;body&gt;
		&lt;h1&gt;欢迎来到我们的网站&lt;/h1&gt;
	&lt;/body&gt;
&lt;/html&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>通过Nginx实现当访问www.访问到系统的首页</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name www.hm.com;
	location /{
		root /usr/local/nginx/html/hm;
		index index.html;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>》通过Rewrite完成将www.360buy.com的请求跳转到www.jd.com</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name www.360buy.com;
	rewrite ^/ http://www.jd.com permanent;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>问题描述:如何在域名跳转的过程中携带请求的URI？</p> <p>修改配置信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name www.itheima.com;
	rewrite ^(.*) http://www.hm.com$1 permanent;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>问题描述:我们除了上述说的www.jd.com 、www.360buy.com其实还有我们也可以通过www.jingdong.com来访问，那么如何通过Rewrite来实现多个域名的跳转?</p> <p>添加域名</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /etc/hosts
192.168.200.133 www.jingdong.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>修改配置信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	listen 80;
	server_name www.360buy.com www.jingdong.com;
	rewrite ^(.*) http://www.jd.com$1 permanent;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="域名镜像"><a href="#域名镜像" class="header-anchor">#</a> 域名镜像</h4> <p>上述案例中，将www.360buy.com 和 www.jingdong.com都能跳转到www.jd.com，那么www.jd.com我们就可以把它起名叫主域名，其他两个就是我们所说的镜像域名，当然如果我们不想把整个网站做镜像，只想为其中某一个子目录下的资源做镜像，我们可以在location块中配置rewrite功能，比如:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name rewrite.myweb.com;
	location ^~ /source1{
		rewrite ^/resource1(.*) http://rewrite.myweb.com/web$1 last;
	}
	location ^~ /source2{
		rewrite ^/resource2(.*) http://rewrite.myweb.com/web$1 last;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="独立域名"><a href="#独立域名" class="header-anchor">#</a> 独立域名</h4> <p>一个完整的项目包含多个模块，比如购物网站有商品商品搜索模块、商品详情模块已经购物车模块等，那么我们如何为每一个模块设置独立的域名。</p> <p>需求：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://search.hm.com  访问商品搜索模块
http://item.hm.com	  访问商品详情模块
http://cart.hm.com	  访问商品购物车模块
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	listen 80;
	server_name search.hm.com;
	rewrite ^(.*) http://www.hm.com/bbs$1 last;
}
server{
	listen 81;
	server_name item.hm.com;
	rewrite ^(.*) http://www.hm.com/item$1 last;
}
server{
	listen 82;
	server_name cart.hm.com;
	rewrite ^(.*) http://www.hm.com/cart$1 last;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="目录自动添加"><a href="#目录自动添加" class="header-anchor">#</a> 目录自动添加&quot;/&quot;</h4> <p>问题描述</p> <p>通过一个例子来演示下问题:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen	80;
	server_name localhost;
	location / {
		root html;
		index index.html;
	}
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>要想访问上述资源，很简单，只需要通过http://192.168.200.133直接就能访问，地址后面不需要加/,但是如果将上述的配置修改为如下内容:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen	80;
	server_name localhost;
	location /hm {
		root html;
		index index.html;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这个时候，要想访问上述资源，按照上述的访问方式，我们可以通过http://192.168.200.133/hm/来访问,但是如果地址后面不加斜杠，页面就会出问题。如果不加斜杠，Nginx服务器内部会自动做一个301的重定向，重定向的地址会有一个指令叫server_name_in_redirect on|off;来决定重定向的地址：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>如果该指令为on
	重定向的地址为:  http://server_name/目录名/;
如果该指令为off
	重定向的地址为:  http://原URL中的域名/目录名/;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>所以就拿刚才的地址来说，http://192.168.200.133/hm如果不加斜杠，那么按照上述规则，如果指令server_name_in_redirect为on，则301重定向地址变为 http://localhost/hm/,如果为off，则301重定向地址变为http://192.168.200.133/ht/。后面这个是正常的，前面地址就有问题。</p> <p>注意server_name_in_redirect指令在Nginx的0.8.48版本之前默认都是on，之后改成了off,所以现在我们这个版本不需要考虑这个问题，但是如果是0.8.48以前的版本并且server_name_in_redirect设置为on，我们如何通过rewrite来解决这个问题？</p> <p>解决方案</p> <p>我们可以使用rewrite功能为末尾没有斜杠的URL自动添加一个斜杠</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen	80;
	server_name localhost;
	server_name_in_redirect on;
	location /hm {
		if (-d $request_filename){
			rewrite ^/(.*)([^/])$ http://$host/$1$2/ permanent;
		}
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="合并目录"><a href="#合并目录" class="header-anchor">#</a> 合并目录</h4> <p>搜索引擎优化(SEO)是一种利用搜索引擎的搜索规则来提供目的网站的有关搜索引擎内排名的方式。我们在创建自己的站点时，可以通过很多中方式来有效的提供搜索引擎优化的程度。其中有一项就包含URL的目录层级一般不要超过三层，否则的话不利于搜索引擎的搜索也给客户端的输入带来了负担，但是将所有的文件放在一个目录下又会导致文件资源管理混乱并且访问文件的速度也会随着文件增多而慢下来，这两个问题是相互矛盾的，那么使用rewrite如何解决上述问题?</p> <p>举例，网站中有一个资源文件的访问路径时 /server/11/22/33/44/20.html,也就是说20.html存在于第5级目录下，如果想要访问该资源文件，客户端的URL地址就要写成 <code>http://www.web.name/server/11/22/33/44/20.html</code>,</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name www.web.name;
	location /server{
		root html;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>但是这个是非常不利于SEO搜索引擎优化的，同时客户端也不好记.使用rewrite我们可以进行如下配置:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name www.web.name;
	location /server{
		rewrite ^/server-([0-9]+)-([0-9]+)-([0-9]+)-([0-9]+)\.html$ /server/$1/$2/$3/$4/$5.html last;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这样的花，客户端只需要输入http://www.web.name/server-11-22-33-44-20.html就可以访问到20.html页面了。这里也充分利用了rewrite指令支持正则表达式的特性。</p> <h4 id="防盗链"><a href="#防盗链" class="header-anchor">#</a> 防盗链</h4> <p>防盗链之前我们已经介绍过了相关的知识，在rewrite中的防盗链和之前将的原理其实都是一样的，只不过通过rewrite可以将防盗链的功能进行完善下，当出现防盗链的情况，我们可以使用rewrite将请求转发到自定义的一张图片和页面，给用户比较好的提示信息。下面我们就通过根据文件类型实现防盗链的一个配置实例:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	listen 80;
	server_name www.web.com;
	locatin ~* ^.+\.(gif|jpg|png|swf|flv|rar|zip)${
		valid_referers none blocked server_names *.web.com;
		if ($invalid_referer){
			rewrite ^/ http://www.web.com/images/forbidden.png;
		}
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>根据目录实现防盗链配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	listen 80;
	server_name www.web.com;
	location /file/{
		root /server/file/;
		valid_referers none blocked server_names *.web.com;
		if ($invalid_referer){
			rewrite ^/ http://www.web.com/images/forbidden.png;
		}
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="rewrite功能配置-2"><a href="#rewrite功能配置-2" class="header-anchor">#</a> Rewrite功能配置</h2> <p>Rewrite是Nginx服务器提供的一个重要基本功能，是Web服务器产品中几乎必备的功能。主要的作用是用来实现URL的重写。www.jd.com
注意:Nginx服务器的Rewrite功能的实现依赖于PCRE的支持，因此在编译安装Nginx服务器之前，需要安装PCRE库。Nginx使用的是ngx_http_rewrite_module模块来解析和处理Rewrite功能的相关配置。</p> <p>Rewrite的相关命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>set指令
if指令
break指令
return指令
rewrite指令
rewrite_log指令
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Rewrite的应用场景</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>域名跳转
域名镜像
独立域名
目录自动添加&quot;/&quot;
合并目录
防盗链的实现
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="rewrite的相关指令"><a href="#rewrite的相关指令" class="header-anchor">#</a> Rewrite的相关指令</h3> <h4 id="set指令-2"><a href="#set指令-2" class="header-anchor">#</a> set指令</h4> <p>该指令用来设置一个新的变量。</p> <table><thead><tr><th>语法</th> <th>set $variable value;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location、if</td></tr></tbody></table> <p>variable:变量的名称，该变量名称要用&quot;$&quot;作为变量的第一个字符，且不要与Nginx服务器预设的全局变量同名。</p> <p>value:变量的值，可以是字符串、其他变量或者变量的组合等。</p> <h4 id="rewrite常用全局变量-2"><a href="#rewrite常用全局变量-2" class="header-anchor">#</a> Rewrite常用全局变量</h4> <table><thead><tr><th>变量</th> <th>说明</th></tr></thead> <tbody><tr><td>$args</td> <td>变量中存放了请求URL中的请求参数。比如http://192.168.200.133/server?arg1=value1&amp;args2=value2中的&quot;arg1=value1&amp;arg2=value2&quot;，功能和$query_string一样</td></tr> <tr><td>$http_user_agent</td> <td>变量存储的是用户访问服务的代理信息(如果通过浏览器访问，记录的是浏览器的相关版本信息)</td></tr> <tr><td>$host</td> <td>变量存储的是访问服务器的server_name值</td></tr> <tr><td>$document_uri</td> <td>变量存储的是当前访问地址的URI。比如http://192.168.200.133/server?id=10&amp;name=zhangsan中的&quot;/server&quot;，功能和$uri一样</td></tr> <tr><td>$document_root</td> <td>变量存储的是当前请求对应location的root值，如果未设置，默认指向Nginx自带html目录所在位置</td></tr> <tr><td>$content_length</td> <td>变量存储的是请求头中的Content-Length的值</td></tr> <tr><td>$content_type</td> <td>变量存储的是请求头中的Content-Type的值</td></tr> <tr><td>$http_cookie</td> <td>变量存储的是客户端的cookie信息，可以通过add_header Set-Cookie 'cookieName=cookieValue'来添加cookie数据</td></tr> <tr><td>$limit_rate</td> <td>变量中存储的是Nginx服务器对网络连接速率的限制，也就是Nginx配置中对limit_rate指令设置的值，默认是0，不限制。</td></tr> <tr><td>$remote_addr</td> <td>变量中存储的是客户端的IP地址</td></tr> <tr><td>$remote_port</td> <td>变量中存储了客户端与服务端建立连接的端口号</td></tr> <tr><td>$remote_user</td> <td>变量中存储了客户端的用户名，需要有认证模块才能获取</td></tr> <tr><td>$scheme</td> <td>变量中存储了访问协议</td></tr> <tr><td>$server_addr</td> <td>变量中存储了服务端的地址</td></tr> <tr><td>$server_name</td> <td>变量中存储了客户端请求到达的服务器的名称</td></tr> <tr><td>$server_port</td> <td>变量中存储了客户端请求到达服务器的端口号</td></tr> <tr><td>$server_protocol</td> <td>变量中存储了客户端请求协议的版本，比如&quot;HTTP/1.1&quot;</td></tr> <tr><td>$request_body_file</td> <td>变量中存储了发给后端服务器的本地文件资源的名称</td></tr> <tr><td>$request_method</td> <td>变量中存储了客户端的请求方式，比如&quot;GET&quot;,&quot;POST&quot;等</td></tr> <tr><td>$request_filename</td> <td>变量中存储了当前请求的资源文件的路径名</td></tr> <tr><td>$request_uri</td> <td>变量中存储了当前请求的URI，并且携带请求参数，比如http://192.168.200.133/server?id=10&amp;name=zhangsan中的&quot;/server?id=10&amp;name=zhangsan&quot;</td></tr></tbody></table> <p>上述参数还可以在日志文件中使用，这个就要用到前面我们介绍的<code>log_format</code>指令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>log_format main '$remote_addr - $request - $status-$request_uri  $http_user_agent';

access_log logs/access.log main;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="if指令-2"><a href="#if指令-2" class="header-anchor">#</a> if指令</h4> <p>该指令用来支持条件判断，并根据条件判断结果选择不同的Nginx配置。</p> <table><thead><tr><th>语法</th> <th>if  (condition){...}</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location</td></tr></tbody></table> <p>condition为判定条件，可以支持以下写法：</p> <ol><li>变量名。如果变量名对应的值为空字符串或&quot;0&quot;，if都判断为false,其他条件为true。</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>if ($param){
	
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>使用&quot;=&quot;和&quot;!=&quot;比较变量和字符串是否相等，满足条件为true，不满足为false</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>if ($request_method = POST){
	return 405;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意：此处和Java不太一样的地方是字符串不需要添加引号,并且等号和不等号前后到需要加空格。</p> <ol start="3"><li><p>使用正则表达式对变量进行匹配，匹配成功返回true，否则返回false。变量与正则表达式之间使用&quot;~&quot;,&quot;~*&quot;,&quot;!~&quot;,&quot;!~*&quot;来连接。</p> <p>&quot;~&quot;代表匹配正则表达式过程中区分大小写，</p> <p>&quot;~*&quot;代表匹配正则表达式过程中不区分大小写</p> <p>&quot;!~&quot;和&quot;!~*&quot;刚好和上面取相反值，如果匹配上返回false,匹配不上返回true</p></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>if ($http_user_agent ~ MSIE){
	#$http_user_agent的值中是否包含MSIE字符串，如果包含返回true
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意：正则表达式字符串一般不需要加引号，但是如果字符串中包含&quot;}&quot;或者是&quot;;&quot;等字符时，就需要把引号加上。</p> <ol start="4"><li>判断请求的文件是否存在使用&quot;-f&quot;和&quot;!-f&quot;,</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>if (-f $request_filename){
	#判断请求的文件是否存在
}
if (!-f $request_filename){
	#判断请求的文件是否不存在
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="5"><li><p>判断请求的目录是否存在使用&quot;-d&quot;和&quot;!-d&quot;</p></li> <li><p>判断请求的目录或者文件是否存在使用&quot;-e&quot;和&quot;!-e&quot;</p></li> <li><p>判断请求的文件是否可执行使用&quot;-x&quot;和&quot;!-x&quot;</p></li></ol> <h4 id="break指令-2"><a href="#break指令-2" class="header-anchor">#</a> break指令</h4> <p>该指令用于中断当前相同作用域中的其他Nginx配置。与该指令处于同一作用域的Nginx配置中，位于它前面的指令配置生效，位于后面的指令配置无效。并且break还有另外一个功能就是终止当前的匹配并把当前的URI在本location进行重定向访问处理。</p> <table><thead><tr><th>语法</th> <th>break;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location、if</td></tr></tbody></table> <p>例子:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /testbreak{
	default_type text/plain;
	set $username TOM;
	if ($args){
		Set $username JERRY;
        break;
		set $username ROSE;
	}
	add_header username $username;
	return 200 $username;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="return指令-2"><a href="#return指令-2" class="header-anchor">#</a> return指令</h4> <p>该指令用于完成对请求的处理，直接向客户端返回。在return后的所有Nginx配置都是无效的。</p> <table><thead><tr><th>语法</th> <th>return code [text];<br>return code URL;<br>return URL;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location、if</td></tr></tbody></table> <p>code:为返回给客户端的HTTP状态代理。可以返回的状态代码为0~999的任意HTTP状态代理</p> <p>text:为返回给客户端的响应体内容，支持变量的使用</p> <p>URL:为返回给客户端的URL地址</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /testreturn {

	return 200 success;
}

location /testreturn {

	return https://www.baidu.com; // 302重定向到百度
}

location /testreturn {
	return 302 https://www.baidu.com;
}

location /testreturn {
	return 302 www.baidu.com;//不允许这么写
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="rewrite指令-2"><a href="#rewrite指令-2" class="header-anchor">#</a> rewrite指令</h4> <p>该指令通过正则表达式的使用来改变URI。可以同时存在一个或者多个指令，按照顺序依次对URL进行匹配和处理。</p> <table><thead><tr><th>语法</th> <th>rewrite regex replacement [flag];</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>server、location、if</td></tr></tbody></table> <p>regex:用来匹配URI的正则表达式</p> <p>replacement:匹配成功后，用于替换URI中被截取内容的字符串。如果该字符串是以&quot;http://&quot;或者&quot;https://&quot;开头的，则不会继续向下对URI进行其他处理，而是直接返回重写后的URI给客户端。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location rewrite {
	rewrite ^/rewrite/url\w*$ https://www.baidu.com;
	rewrite ^/rewrite/(test)\w*$ /$1;
	rewrite ^/rewrite/(demo)\w*$ /$1;
}
location /test{
	default_type text/plain;
	return 200 test_success;
}
location /demo{
	default_type text/plain;
	return 200 demo_success;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>flag:用来设置rewrite对URI的处理行为，可选值有如下：</p> <ul><li>last:终止继续在本location块中处理接收到的URI，并将此处重写的URI作为一个新的URI，使用各location块进行处理。该标志将重写后的URI重写在server块中执行，为重写后的URI提供了转入到其他location块的机会。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>location rewrite {
	rewrite ^/rewrite/(test)\w*$ /$1 last;
	rewrite ^/rewrite/(demo)\w*$ /$1 last;
}
location /test{
	default_type text/plain;
	return 200 test_success;
}
location /demo{
	default_type text/plain;
	return 200 demo_success;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>访问 <code>http://192.168.200.133:8081/rewrite/testabc</code>,能正确访问</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1589475653252.png" alt="1589475653252"></p> <ul><li>break：将此处重写的URI作为一个新的URI,在本块中继续进行处理。该标志将重写后的地址在当前的location块中执行，不会将新的URI转向其他的location块。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>location rewrite {
    #/test   /usr/local/nginx/html/test/index.html
	rewrite ^/rewrite/(test)\w*$ /$1 break;
	rewrite ^/rewrite/(demo)\w*$ /$1 break;
}
location /test{
	default_type text/plain;
	return 200 test_success;
}
location /demo{
	default_type text/plain;
	return 200 demo_success;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>访问 <code>http://192.168.200.133:8081/rewrite/demoabc</code>,页面报404错误</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1589475732042.png" alt="1589475732042"></p> <ul><li>redirect：将重写后的URI返回给客户端，状态码为302，指明是临时重定向URI,主要用在replacement变量不是以&quot;http://&quot;或者&quot;https://&quot;开头的情况。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>location rewrite {
	rewrite ^/rewrite/(test)\w*$ /$1 redirect;
	rewrite ^/rewrite/(demo)\w*$ /$1 redirect;
}
location /test{
	default_type text/plain;
	return 200 test_success;
}
location /demo{
	default_type text/plain;
	return 200 demo_success;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>访问<code>http://192.168.200.133:8081/rewrite/testabc</code>请求会被临时重定向，浏览器地址也会发生改变</p> <ul><li>permanent：将重写后的URI返回给客户端，状态码为301，指明是永久重定向URI,主要用在replacement变量不是以&quot;http://&quot;或者&quot;https://&quot;开头的情况。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>location rewrite {
	rewrite ^/rewrite/(test)\w*$ /$1 permanent;
	rewrite ^/rewrite/(demo)\w*$ /$1 permanent;
}
location /test{
	default_type text/plain;
	return 200 test_success;
}
location /demo{
	default_type text/plain;
	return 200 demo_success;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>访问<code>http://192.168.200.133:8081/rewrite/testabc</code>请求会被永久重定向，浏览器地址也会发生改变</p> <h4 id="rewrite-log指令-2"><a href="#rewrite-log指令-2" class="header-anchor">#</a> rewrite_log指令</h4> <p>该指令配置是否开启URL重写日志的输出功能。</p> <table><thead><tr><th>语法</th> <th>rewrite_log on|off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>rewrite_log off;</td></tr> <tr><td>位置</td> <td>http、server、location、if</td></tr></tbody></table> <p>开启后，URL重写的相关日志将以notice级别输出到error_log指令配置的日志文件汇总。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>rewrite_log on;
error_log  logs/error.log notice;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="rewrite的案例-2"><a href="#rewrite的案例-2" class="header-anchor">#</a> Rewrite的案例</h3> <h4 id="域名跳转-2"><a href="#域名跳转-2" class="header-anchor">#</a> 域名跳转</h4> <p>》问题分析</p> <p>先来看一个效果，如果我们想访问京东网站，大家都知道我们可以输入<code>www.jd.com</code>,但是同样的我们也可以输入<code>www.360buy.com</code>同样也都能访问到京东网站。这个其实是因为京东刚开始的时候域名就是www.360buy.com，后面由于各种原因把自己的域名换成了www.jd.com, 虽然说域名变量，但是对于以前只记住了www.360buy.com的用户来说，我们如何把这部分用户也迁移到我们新域名的访问上来，针对于这个问题，我们就可以使用Nginx中Rewrite的域名跳转来解决。</p> <p>》环境准备</p> <ul><li>准备三个域名：</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /etc/hosts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>127.0.0.1   www.itcast.cn
127.0.0.1   www.itheima.cn
127.0.0.1   www.itheima.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>通过Nginx实现访问www.itcast.cn</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name www.itcast.cn;
	location /{
		default_type text/html;
		return 200 '&lt;h1&gt;welcome to itcast&lt;/h1&gt;';
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>》通过Rewrite完成将www.ithema.com和www.itheima.cn的请求跳转到www.itcast.com</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name www.itheima.com www.itheima.cn;
	rewrite ^/ http://www.itcast.cn;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>问题描述:如何在域名跳转的过程中携带请求的URI？</p> <p>修改配置信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name www.itheima.com www.itheima.cn;
	rewrite ^(.*) http://www.itcast.cn$1；
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="域名镜像-2"><a href="#域名镜像-2" class="header-anchor">#</a> 域名镜像</h4> <p>镜像网站指定是将一个完全相同的网站分别放置到几台服务器上，并分别使用独立的URL进行访问。其中一台服务器上的网站叫主站，其他的为镜像网站。镜像网站和主站没有太大的区别，可以把镜像网站理解为主站的一个备份节点。可以通过镜像网站提供网站在不同地区的响应速度。镜像网站可以平衡网站的流量负载、可以解决网络宽带限制、封锁等。</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1589560433192.png" alt="1589560433192"></p> <p>而我们所说的域名镜像和网站镜像比较类似，上述案例中，将www.itheima.com和 www.itheima.cn都能跳转到www.itcast.cn，那么www.itcast.cn我们就可以把它起名叫主域名，其他两个就是我们所说的镜像域名，当然如果我们不想把整个网站做镜像，只想为其中某一个子目录下的资源做镜像，我们可以在location块中配置rewrite功能，比如:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
    listen          80;
    server_name     www.itheima.cn www.itheima.com;
    location /user {
    	rewrite ^/user(.*)$ http://www.itcast.cn$1;
    }
    location /emp{
        default_type text/html;
        return 200 '&lt;h1&gt;emp_success&lt;/h1&gt;';
    }
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="独立域名-2"><a href="#独立域名-2" class="header-anchor">#</a> 独立域名</h4> <p>一个完整的项目包含多个模块，比如购物网站有商品搜索模块、商品详情模块和购物车模块等，那么我们如何为每一个模块设置独立的域名。</p> <p>需求：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://search.itcast.com:81  访问商品搜索模块
http://item.itcast.com:82	  访问商品详情模块
http://cart.itcast.com:83	  访问商品购物车模块
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	listen 81;
	server_name search.itcast.com;
	rewrite ^(.*) http://www.itcast.cn/search$1;
}
server{
	listen 82;
	server_name item.itcast.com;
	rewrite ^(.*) http://www.itcast.cn/item$1;
}
server{
	listen 83;
	server_name cart.itcast.com;
	rewrite ^(.*) http://www.itcast.cn/cart$1;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="目录自动添加-2"><a href="#目录自动添加-2" class="header-anchor">#</a> 目录自动添加&quot;/&quot;</h4> <p>问题描述</p> <p>通过一个例子来演示下问题:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen	8082;
	server_name localhost;
	location /heima {
		root html;
		index index.html;
	}
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>通过<code>http://192.168.200.133:8082/heima</code>和通过<code>http://192.168.200.133:8082/heima/</code>访问的区别？</p> <p>如果不加斜杠，Nginx服务器内部会自动做一个301的重定向，重定向的地址会有一个指令叫server_name_in_redirect on|off;来决定重定向的地址：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>如果该指令为on
	重定向的地址为:  http://server_name:8082/目录名/;
	http://localhost:8082/heima/
如果该指令为off
	重定向的地址为:  http://原URL中的域名:8082/目录名/;
	http://192.168.200.133:8082/heima/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>所以就拿刚才的地址来说，http://192.168.200.133:8082/heima如果不加斜杠，那么按照上述规则，如果指令server_name_in_redirect为on，则301重定向地址变为 http://localhost:8082/heima/,如果为off，则301重定向地址变为http://192.168.200.133:8082/heima/。后面这个是正常的，前面地址就有问题。</p> <p>注意server_name_in_redirect指令在Nginx的0.8.48版本之前默认都是on，之后改成了off,所以现在我们这个版本不需要考虑这个问题，但是如果是0.8.48以前的版本并且server_name_in_redirect设置为on，我们如何通过rewrite来解决这个问题？</p> <p>解决方案</p> <p>我们可以使用rewrite功能为末尾没有斜杠的URL自动添加一个斜杠</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen	80;
	server_name localhost;
	server_name_in_redirect on;
	location /heima {
		if (-d $request_filename){
			rewrite ^/(.*)([^/])$ http://$host/$1$2/ permanent;
		}
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="合并目录-2"><a href="#合并目录-2" class="header-anchor">#</a> 合并目录</h4> <p>搜索引擎优化(SEO)是一种利用搜索引擎的搜索规则来提高目的网站在有关搜索引擎内排名的方式。我们在创建自己的站点时，可以通过很多中方式来有效的提供搜索引擎优化的程度。其中有一项就包含URL的目录层级一般不要超过三层，否则的话不利于搜索引擎的搜索也给客户端的输入带来了负担，但是将所有的文件放在一个目录下又会导致文件资源管理混乱并且访问文件的速度也会随着文件增多而慢下来，这两个问题是相互矛盾的，那么使用rewrite如何解决上述问题?</p> <p>举例，网站中有一个资源文件的访问路径时 /server/11/22/33/44/20.html,也就是说20.html存在于第5级目录下，如果想要访问该资源文件，客户端的URL地址就要写成 <code>http://192.168.200.133/server/11/22/33/44/20.html</code>,</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 8083;
	server_name localhost;
	location /server{
		root html;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>但是这个是非常不利于SEO搜索引擎优化的，同时客户端也不好记.使用rewrite我们可以进行如下配置:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 8083;
	server_name localhost;
	location /server{
		rewrite ^/server-([0-9]+)-([0-9]+)-([0-9]+)-([0-9]+)\.html$ /server/$1/$2/$3/$4/$5.html last;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这样的花，客户端只需要输入http://www.web.name/server-11-22-33-44-20.html就可以访问到20.html页面了。这里也充分利用了rewrite指令支持正则表达式的特性。</p> <h4 id="防盗链-2"><a href="#防盗链-2" class="header-anchor">#</a> 防盗链</h4> <p>防盗链之前我们已经介绍过了相关的知识，在rewrite中的防盗链和之前将的原理其实都是一样的，只不过通过rewrite可以将防盗链的功能进行完善下，当出现防盗链的情况，我们可以使用rewrite将请求转发到自定义的一张图片和页面，给用户比较好的提示信息。下面我们就通过根据文件类型实现防盗链的一个配置实例:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>location /images {
    root html;
    valid_referers none blocked www.baidu.com;
    if ($invalid_referer){
        #return 403;
        rewrite ^/    /images/forbidden.png break;
    }
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="nginx反向代理"><a href="#nginx反向代理" class="header-anchor">#</a> Nginx反向代理</h2> <h3 id="nginx反向代理概述"><a href="#nginx反向代理概述" class="header-anchor">#</a> Nginx反向代理概述</h3> <p>关于正向代理和反向代理，我们在前面的章节已经通过一张图给大家详细的介绍过了，简而言之就是正向代理代理的对象是客户端，反向代理代理的是服务端，这是两者之间最大的区别。</p> <p>Nginx即可以实现正向代理，也可以实现反向代理。</p> <p>我们先来通过一个小案例演示下Nginx正向代理的简单应用。</p> <p>先提需求：</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1581846370052.png" alt=""></p> <p>(1)服务端的设置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http {
  log_format main 'client send request=&gt;clientIp=$remote_addr serverIp=&gt;$host';
	server{
		listen 80;
		server_name	localhost;
		access_log logs/access.log main;
		location {
			root html;
			index index.html index.htm;
		}
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>(2)使用客户端访问服务端，打开日志查看结果</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1589729000713.png" alt="1589729000713"></p> <p>(3)代理服务器设置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {

        listen  82;
        resolver 8.8.8.8;
        location /{
                proxy_pass http://$host$request_uri;
        }
    }

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>(4)查看代理服务器的IP(192.168.200.146)和Nginx配置监听的端口(82)</p> <p>(5)在客户端配置代理服务器</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1581847577947.png" alt=""></p> <p>(6)设置完成后，再次通过浏览器访问服务端</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1589729479920.png" alt="1589729479920"></p> <p>通过对比，上下两次的日志记录，会发现虽然我们是客户端访问服务端，但是如何使用了代理，那么服务端能看到的只是代理发送过去的请求，这样的化，就使用Nginx实现了正向代理的设置。</p> <p>但是Nginx正向代理，在实际的应用中不是特别多，所以我们简单了解下，接下来我们继续学习Nginx的反向代理，这是Nginx比较重要的一个功能。</p> <h3 id="nginx反向代理的配置语法"><a href="#nginx反向代理的配置语法" class="header-anchor">#</a> Nginx反向代理的配置语法</h3> <p>Nginx反向代理模块的指令是由<code>ngx_http_proxy_module</code>模块进行解析，该模块在安装Nginx的时候已经自己加装到Nginx中了，接下来我们把反向代理中的常用指令一一介绍下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>proxy_pass
proxy_set_header
proxy_redirect
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="proxy-pass"><a href="#proxy-pass" class="header-anchor">#</a> proxy_pass</h4> <p>该指令用来设置被代理服务器地址，可以是主机名称、IP地址加端口号形式。</p> <table><thead><tr><th>语法</th> <th>proxy_pass URL;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>location</td></tr></tbody></table> <p>URL:为要设置的被代理服务器地址，包含传输协议(<code>http</code>,<code>https://</code>)、主机名称或IP地址加端口号、URI等要素。</p> <p>举例：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>proxy_pass http://www.baidu.com;
location /server{}
proxy_pass http://192.168.200.146;
    http://192.168.200.146/server/index.html
proxy_pass http://192.168.200.146/;
    http://192.168.200.146/index.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>大家在编写proxy_pass的时候，后面的值要不要加&quot;/&quot;?</p> <p>接下来通过例子来说明刚才我们提到的问题：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen 80;
	server_name localhost;
	location /{
		#proxy_pass http://192.168.200.146;
		proxy_pass http://192.168.200.146/;
	}
}
当客户端访问 http://localhost/index.html,效果是一样的
server{
	listen 80;
	server_name localhost;
	location /server{
		#proxy_pass http://192.168.200.146;
		proxy_pass http://192.168.200.146/;
	}
}
当客户端访问 http://localhost/server/index.html
这个时候，第一个proxy_pass就变成了http://localhost/server/index.html
第二个proxy_pass就变成了http://localhost/index.html效果就不一样了。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="proxy-set-header"><a href="#proxy-set-header" class="header-anchor">#</a> proxy_set_header</h4> <p>该指令可以更改Nginx服务器接收到的客户端请求的请求头信息，然后将新的请求头发送给代理的服务器</p> <table><thead><tr><th>语法</th> <th>proxy_set_header field value;</th></tr></thead> <tbody><tr><td>默认值</td> <td>proxy_set_header Host $proxy_host;<br>proxy_set_header Connection close;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>需要注意的是，如果想要看到结果，必须在被代理的服务器上来获取添加的头信息。</p> <p>被代理服务器： [192.168.200.146]</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
        listen  8080;
        server_name localhost;
        default_type text/plain;
        return 200 $http_username;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>代理服务器: [192.168.200.133]</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
        listen  8080;
        server_name localhost;
        location /server {
                proxy_pass http://192.168.200.146:8080/;
                proxy_set_header username TOM;
        }
    }

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>访问测试</p> <h4 id="proxy-redirect"><a href="#proxy-redirect" class="header-anchor">#</a> proxy_redirect</h4> <p>该指令是用来重置头信息中的&quot;Location&quot;和&quot;Refresh&quot;的值。</p> <table><thead><tr><th>语法</th> <th>proxy_redirect redirect replacement;<br>proxy_redirect default;<br>proxy_redirect off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>proxy_redirect default;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>》为什么要用该指令?</p> <p>服务端[192.168.200.146]</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
    listen  8081;
    server_name localhost;
    if (!-f $request_filename){
    	return 302 http://192.168.200.146;
    }
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>代理服务端[192.168.200.133]</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
	listen  8081;
	server_name localhost;
	location / {
		proxy_pass http://192.168.200.146:8081/;
		proxy_redirect http://192.168.200.146 http://192.168.200.133;
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>》该指令的几组选项</p> <p>proxy_redirect redirect replacement;</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>redirect:目标,Location的值
replacement:要替换的值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>proxy_redirect default;</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>default;
将location块的uri变量作为replacement,
将proxy_pass变量作为redirect进行替换
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>proxy_redirect off;</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>关闭proxy_redirect的功能
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="nginx反向代理实战"><a href="#nginx反向代理实战" class="header-anchor">#</a> Nginx反向代理实战</h3> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1581883378672.png" alt="1581883378672"></p> <p>服务器1,2,3存在两种情况</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>第一种情况: 三台服务器的内容不一样。
第二种情况: 三台服务器的内容是一样。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol><li>如果服务器1、服务器2和服务器3的内容不一样，那我们可以根据用户请求来分发到不同的服务器。</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>代理服务器
server {
        listen          8082;
        server_name     localhost;
        location /server1 {
                proxy_pass http://192.168.200.146:9001/;
        }
        location /server2 {
                proxy_pass http://192.168.200.146:9002/;
        }
        location /server3 {
                proxy_pass http://192.168.200.146:9003/;
        }
}

服务端
server1
server {
        listen          9001;
        server_name     localhost;
        default_type text/html;
        return 200 '&lt;h1&gt;192.168.200.146:9001&lt;/h1&gt;'
}
server2
server {
        listen          9002;
        server_name     localhost;
        default_type text/html;
        return 200 '&lt;h1&gt;192.168.200.146:9002&lt;/h1&gt;'
}
server3
server {
        listen          9003;
        server_name     localhost;
        default_type text/html;
        return 200 '&lt;h1&gt;192.168.200.146:9003&lt;/h1&gt;'
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><ol start="2"><li>如果服务器1、服务器2和服务器3的内容是一样的，该如何处理?</li></ol> <h3 id="nginx的安全控制"><a href="#nginx的安全控制" class="header-anchor">#</a> Nginx的安全控制</h3> <p>关于web服务器的安全是比较大的一个话题，里面所涉及的内容很多，Nginx反向代理是如何来提升web服务器的安全呢？</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>安全隔离
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>什么是安全隔离?</p> <p>通过代理分开了客户端到应用程序服务器端的连接，实现了安全措施。在反向代理之前设置防火墙，仅留一个入口供代理服务器访问。</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1589908851340.png" alt="1589908851340"></p> <h4 id="如何使用ssl对流量进行加密"><a href="#如何使用ssl对流量进行加密" class="header-anchor">#</a> 如何使用SSL对流量进行加密</h4> <p>翻译成大家能熟悉的说法就是将我们常用的http请求转变成https请求，那么这两个之间的区别简单的来说两个都是HTTP协议，只不过https是身披SSL外壳的http.</p> <p>HTTPS是一种通过计算机网络进行安全通信的传输协议。它经由HTTP进行通信，利用SSL/TLS建立全通信，加密数据包，确保数据的安全性。</p> <p>SSL(Secure Sockets Layer)安全套接层</p> <p>TLS(Transport Layer Security)传输层安全</p> <p>上述这两个是为网络通信提供安全及数据完整性的一种安全协议，TLS和SSL在传输层和应用层对网络连接进行加密。</p> <p>总结来说为什么要使用https:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http协议是明文传输数据，存在安全问题，而https是加密传输，相当于http+ssl，并且可以防止流量劫持。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Nginx要想使用SSL，需要满足一个条件即需要添加一个模块<code>--with-http_ssl_module</code>,而该模块在编译的过程中又需要OpenSSL的支持，这个我们之前已经准备好了。</p> <h5 id="nginx添加ssl的支持"><a href="#nginx添加ssl的支持" class="header-anchor">#</a> nginx添加SSL的支持</h5> <p>（1）完成 <code>--with-http_ssl_module</code>模块的增量添加</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>》将原有/usr/local/nginx/sbin/nginx进行备份
》拷贝nginx之前的配置信息
》在nginx的安装源码进行配置指定对应模块  ./configure --with-http_ssl_module
》通过make模板进行编译
》将objs下面的nginx移动到/usr/local/nginx/sbin下
》在源码目录下执行  make upgrade进行升级，这个可以实现不停机添加新模块的功能
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="nginx的ssl相关指令"><a href="#nginx的ssl相关指令" class="header-anchor">#</a> Nginx的SSL相关指令</h5> <p>因为刚才我们介绍过该模块的指令都是通过ngx_http_ssl_module模块来解析的。</p> <p>》ssl:该指令用来在指定的服务器开启HTTPS,可以使用 listen 443 ssl,后面这种方式更通用些。</p> <table><thead><tr><th>语法</th> <th>ssl on | off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>ssl off;</td></tr> <tr><td>位置</td> <td>http、server</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>server{
	listen 443 ssl;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>》ssl_certificate:为当前这个虚拟主机指定一个带有PEM格式证书的证书。</p> <table><thead><tr><th>语法</th> <th>ssl_certificate file;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>http、server</td></tr></tbody></table> <p>》ssl_certificate_key:该指令用来指定PEM secret key文件的路径</p> <table><thead><tr><th>语法</th> <th>ssl_ceritificate_key file;</th></tr></thead> <tbody><tr><td>默认值</td> <td>—</td></tr> <tr><td>位置</td> <td>http、server</td></tr></tbody></table> <p>》ssl_session_cache:该指令用来配置用于SSL会话的缓存</p> <table><thead><tr><th>语法</th> <th>ssl_sesion_cache off|none|[builtin[:size]] [shared:name:size]</th></tr></thead> <tbody><tr><td>默认值</td> <td>ssl_session_cache none;</td></tr> <tr><td>位置</td> <td>http、server</td></tr></tbody></table> <p>off:禁用会话缓存，客户端不得重复使用会话</p> <p>none:禁止使用会话缓存，客户端可以重复使用，但是并没有在缓存中存储会话参数</p> <p>builtin:内置OpenSSL缓存，仅在一个工作进程中使用。</p> <p>shared:所有工作进程之间共享缓存，缓存的相关信息用name和size来指定</p> <p>》ssl_session_timeout：开启SSL会话功能后，设置客户端能够反复使用储存在缓存中的会话参数时间。</p> <table><thead><tr><th>语法</th> <th>ssl_session_timeout time;</th></tr></thead> <tbody><tr><td>默认值</td> <td>ssl_session_timeout 5m;</td></tr> <tr><td>位置</td> <td>http、server</td></tr></tbody></table> <p>》ssl_ciphers:指出允许的密码，密码指定为OpenSSL支持的格式</p> <table><thead><tr><th>语法</th> <th>ssl_ciphers ciphers;</th></tr></thead> <tbody><tr><td>默认值</td> <td>ssl_ciphers HIGH:!aNULL:!MD5;</td></tr> <tr><td>位置</td> <td>http、server</td></tr></tbody></table> <p>可以使用<code>openssl ciphers</code>查看openssl支持的格式。</p> <p>》ssl_prefer_server_ciphers：该指令指定是否服务器密码优先客户端密码</p> <table><thead><tr><th>语法</th> <th>ssl_perfer_server_ciphers on|off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>ssl_perfer_server_ciphers off;</td></tr> <tr><td>位置</td> <td>http、server</td></tr></tbody></table> <h5 id="生成证书"><a href="#生成证书" class="header-anchor">#</a> 生成证书</h5> <p>方式一：使用阿里云/腾讯云等第三方服务进行购买。</p> <p>方式二:使用openssl生成证书</p> <p>先要确认当前系统是否有安装openssl</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>openssl version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装下面的命令进行生成</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir /root/cert
cd /root/cert
openssl genrsa -des3 -out server.key 1024
openssl req -new -key server.key -out server.csr
cp server.key server.key.org
openssl rsa -in server.key.org -out server.key
openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="开启ssl实例"><a href="#开启ssl实例" class="header-anchor">#</a> 开启SSL实例</h5> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
    listen       443 ssl;
    server_name  localhost;

    ssl_certificate      server.cert;
    ssl_certificate_key  server.key;

    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;

    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;

    location / {
        root   html;
        index  index.html index.htm;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>（4）验证</p> <h3 id="反向代理系统调优"><a href="#反向代理系统调优" class="header-anchor">#</a> 反向代理系统调优</h3> <p>反向代理值Buffer和Cache</p> <p>Buffer翻译过来是&quot;缓冲&quot;，Cache翻译过来是&quot;缓存&quot;。</p> <p><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/document/nginx/assets02/1581879638569.png" alt="1581879638569"></p> <p>总结下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>相同点:
两种方式都是用来提供IO吞吐效率，都是用来提升Nginx代理的性能。
不同点:
缓冲主要用来解决不同设备之间数据传递速度不一致导致的性能低的问题，缓冲中的数据一旦此次操作完成后，就可以删除。
缓存主要是备份，将被代理服务器的数据缓存一份到代理服务器，这样的话，客户端再次获取相同数据的时候，就只需要从代理服务器上获取，效率较高，缓存中的数据可以重复使用，只有满足特定条件才会删除.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>（1）Proxy Buffer相关指令</p> <p>》proxy_buffering :该指令用来开启或者关闭代理服务器的缓冲区；</p> <table><thead><tr><th>语法</th> <th>proxy_buffering on|off;</th></tr></thead> <tbody><tr><td>默认值</td> <td>proxy_buffering on;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>》proxy_buffers:该指令用来指定单个连接从代理服务器读取响应的缓存区的个数和大小。</p> <table><thead><tr><th>语法</th> <th>proxy_buffers number size;</th></tr></thead> <tbody><tr><td>默认值</td> <td>proxy_buffers 8 4k | 8K;(与系统平台有关)</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>number:缓冲区的个数</p> <p>size:每个缓冲区的大小，缓冲区的总大小就是number*size</p> <p>》proxy_buffer_size:该指令用来设置从被代理服务器获取的第一部分响应数据的大小。保持与proxy_buffers中的size一致即可，当然也可以更小。</p> <table><thead><tr><th>语法</th> <th>proxy_buffer_size size;</th></tr></thead> <tbody><tr><td>默认值</td> <td>proxy_buffer_size 4k | 8k;(与系统平台有关)</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>》proxy_busy_buffers_size：该指令用来限制同时处于BUSY状态的缓冲总大小。</p> <table><thead><tr><th>语法</th> <th>proxy_busy_buffers_size size;</th></tr></thead> <tbody><tr><td>默认值</td> <td>proxy_busy_buffers_size 8k|16K;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>》proxy_temp_path:当缓冲区存满后，仍未被Nginx服务器完全接受，响应数据就会被临时存放在磁盘文件上，该指令设置文件路径</p> <table><thead><tr><th>语法</th> <th>proxy_temp_path  path;</th></tr></thead> <tbody><tr><td>默认值</td> <td>proxy_temp_path proxy_temp;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>注意path最多设置三层。</p> <p>》proxy_temp_file_write_size：该指令用来设置磁盘上缓冲文件的大小。</p> <table><thead><tr><th>语法</th> <th>proxy_temp_file_write_size size;</th></tr></thead> <tbody><tr><td>默认值</td> <td>proxy_temp_file_write_size 8K|16K;</td></tr> <tr><td>位置</td> <td>http、server、location</td></tr></tbody></table> <p>通用网站的配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>proxy_buffering on;
proxy_buffer_size 4 32k;
proxy_busy_buffers_size 64k;
proxy_temp_file_write_size 64k;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>根据项目的具体内容进行相应的调节。</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2024/7/31 21:40:38</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx进阶" class="sidebar-link reco-side-nginx进阶" data-v-cb1513f6>Nginx进阶</a></li><li class="level-2" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx服务器基础配置实例" class="sidebar-link reco-side-nginx服务器基础配置实例" data-v-cb1513f6>Nginx服务器基础配置实例</a></li><li class="level-2" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx服务操作的问题" class="sidebar-link reco-side-nginx服务操作的问题" data-v-cb1513f6>Nginx服务操作的问题</a></li><li class="level-2" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx配置成系统服务" class="sidebar-link reco-side-nginx配置成系统服务" data-v-cb1513f6>Nginx配置成系统服务</a></li><li class="level-2" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx命令配置到系统环境" class="sidebar-link reco-side-nginx命令配置到系统环境" data-v-cb1513f6>Nginx命令配置到系统环境</a></li><li class="level-2" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx静态资源部署" class="sidebar-link reco-side-nginx静态资源部署" data-v-cb1513f6>Nginx静态资源部署</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx静态资源概述" class="sidebar-link reco-side-nginx静态资源概述" data-v-cb1513f6>Nginx静态资源概述</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx静态资源的配置指令" class="sidebar-link reco-side-nginx静态资源的配置指令" data-v-cb1513f6>Nginx静态资源的配置指令</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#静态资源优化配置语法" class="sidebar-link reco-side-静态资源优化配置语法" data-v-cb1513f6>静态资源优化配置语法</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx静态资源压缩实战" class="sidebar-link reco-side-nginx静态资源压缩实战" data-v-cb1513f6>Nginx静态资源压缩实战</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#静态资源的缓存处理" class="sidebar-link reco-side-静态资源的缓存处理" data-v-cb1513f6>静态资源的缓存处理</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx的跨域问题解决" class="sidebar-link reco-side-nginx的跨域问题解决" data-v-cb1513f6>Nginx的跨域问题解决</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#静态资源防盗链" class="sidebar-link reco-side-静态资源防盗链" data-v-cb1513f6>静态资源防盗链</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#rewrite功能配置" class="sidebar-link reco-side-rewrite功能配置" data-v-cb1513f6>Rewrite功能配置</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#rewrite的案例" class="sidebar-link reco-side-rewrite的案例" data-v-cb1513f6>Rewrite的案例</a></li><li class="level-2" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#rewrite功能配置-2" class="sidebar-link reco-side-rewrite功能配置-2" data-v-cb1513f6>Rewrite功能配置</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#rewrite的相关指令" class="sidebar-link reco-side-rewrite的相关指令" data-v-cb1513f6>Rewrite的相关指令</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#rewrite的案例-2" class="sidebar-link reco-side-rewrite的案例-2" data-v-cb1513f6>Rewrite的案例</a></li><li class="level-2" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx反向代理" class="sidebar-link reco-side-nginx反向代理" data-v-cb1513f6>Nginx反向代理</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx反向代理概述" class="sidebar-link reco-side-nginx反向代理概述" data-v-cb1513f6>Nginx反向代理概述</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx反向代理的配置语法" class="sidebar-link reco-side-nginx反向代理的配置语法" data-v-cb1513f6>Nginx反向代理的配置语法</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx反向代理实战" class="sidebar-link reco-side-nginx反向代理实战" data-v-cb1513f6>Nginx反向代理实战</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#nginx的安全控制" class="sidebar-link reco-side-nginx的安全控制" data-v-cb1513f6>Nginx的安全控制</a></li><li class="level-3" data-v-cb1513f6><a href="/views/xi-tong/2024/nginx02.html#反向代理系统调优" class="sidebar-link reco-side-反向代理系统调优" data-v-cb1513f6>反向代理系统调优</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div data-v-70e90cde><div class="reco-bgm-panel" data-v-70e90cde><audio id="bgm" src="https://sugarys.oss-cn-beijing.aliyuncs.com/bgmusic/music.mp3" data-v-70e90cde></audio> <div class="reco-float-box" style="bottom:10px;z-index:999999;display:none;" data-v-70e90cde data-v-6046dea2 data-v-70e90cde><img src="https://sugarys.oss-cn-beijing.aliyuncs.com/bgmusic/music.png" data-v-70e90cde></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-70e90cde data-v-6046dea2 data-v-70e90cde><div class="reco-bgm-cover" style="background-image:url(https://sugarys.oss-cn-beijing.aliyuncs.com/bgmusic/music.png);" data-v-70e90cde><div class="mini-operation" style="display:none;" data-v-70e90cde><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-70e90cde></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-70e90cde></i></div> <div class="falut-message" style="display:none;" data-v-70e90cde>播放失败</div></div> <div class="reco-bgm-info" data-v-70e90cde data-v-6046dea2 data-v-70e90cde><div class="info-box" data-v-70e90cde><i class="reco-bgm reco-bgm-music music" data-v-70e90cde></i>悬溺
            </div> <div class="info-box" data-v-70e90cde><i class="reco-bgm reco-bgm-artist" data-v-70e90cde></i>葛东琪
            </div> <div class="reco-bgm-progress" data-v-70e90cde><div class="progress-bar" data-v-70e90cde><div class="bar" data-v-70e90cde></div></div></div> <div class="reco-bgm-operation" data-v-70e90cde><i class="reco-bgm reco-bgm-last last" data-v-70e90cde></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-70e90cde></i> <i class="reco-bgm reco-bgm-play play" data-v-70e90cde></i> <i class="reco-bgm reco-bgm-next next" data-v-70e90cde></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-70e90cde></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-70e90cde></i> <div class="volume-bar" data-v-70e90cde><div class="bar" data-v-70e90cde></div></div></div></div> <div class="reco-bgm-left-box" data-v-70e90cde data-v-6046dea2 data-v-70e90cde><i class="reco-bgm reco-bgm-left" data-v-70e90cde></i></div></div></div></div><!----><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div></div></div>
    <script src="/assets/js/app.04483c44.js" defer></script><script src="/assets/js/3.46854e42.js" defer></script><script src="/assets/js/1.32674175.js" defer></script><script src="/assets/js/34.0f5f0754.js" defer></script><script src="/assets/js/9.601bab32.js" defer></script>
  </body>
</html>
